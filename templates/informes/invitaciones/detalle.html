{% extends 'informes/base.html' %}
{% load static %}

{% block title %}Detalle de Invitación - AgroTech Histórico{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #2d5016 0%, #4a8234 100%);
        color: white;
    }
    
    .badge-success { background: #4a8234; }
    .badge-warning { background: #f39c12; }
    .badge-danger { background: #e74c3c; }
    
    .info-item {
        border-left: 3px solid #4a8234;
        padding: 10px 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
    }
    
    .timeline-item {
        border-left: 3px solid #ddd;
        padding: 15px 20px;
        margin-bottom: 15px;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -7px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4a8234;
    }
    
    .timeline-item.completed {
        border-left-color: #4a8234;
    }
    
    .timeline-item.pending {
        border-left-color: #f39c12;
    }
    
    .timeline-item.expired {
        border-left-color: #e74c3c;
    }
    
    .qr-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border: 2px dashed #4a8234;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-dark">
            <i class="fas fa-envelope-open me-2"></i>
            Detalle de Invitación
        </h1>
        <div>
            <a href="{% url 'informes:gestionar_invitaciones' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
            {% if not invitacion.fecha_utilizacion and not invitacion.esta_expirada %}
            <button class="btn btn-success" 
                    onclick="copiarEnlace('{{ url_completa }}')">
                <i class="fas fa-link me-2"></i>Copiar Enlace
            </button>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Información Principal -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Información de la Invitación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <strong>Cliente:</strong><br>
                                {{ invitacion.nombre_cliente }}
                            </div>
                            
                            <div class="info-item">
                                <strong>Email:</strong><br>
                                <a href="mailto:{{ invitacion.email_cliente }}">{{ invitacion.email_cliente }}</a>
                            </div>
                            
                            <div class="info-item">
                                <strong>Estado:</strong><br>
                                {% if invitacion.esta_expirada %}
                                    <span class="badge badge-danger">Expirada</span>
                                {% elif invitacion.fecha_utilizacion %}
                                    <span class="badge badge-success">Completada</span>
                                {% else %}
                                    <span class="badge badge-warning">Pendiente</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="info-item">
                                <strong>Fecha de Creación:</strong><br>
                                {{ invitacion.fecha_creacion|date:"d/m/Y H:i" }}
                            </div>
                            
                            <div class="info-item">
                                <strong>Fecha de Vencimiento:</strong><br>
                                {{ invitacion.fecha_expiracion|date:"d/m/Y H:i" }}
                                {% if invitacion.esta_expirada %}
                                    <br><small class="text-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Esta invitación ha expirado
                                    </small>
                                {% endif %}
                            </div>
                            
                            {% if invitacion.fecha_utilizacion %}
                            <div class="info-item">
                                <strong>Completada el:</strong><br>
                                {{ invitacion.fecha_utilizacion|date:"d/m/Y H:i" }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Servicio -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Detalles del Servicio
                    </h5>
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <strong>Descripción:</strong><br>
                        {{ invitacion.descripcion_servicio|default:"Análisis satelital de parcela agrícola" }}
                    </div>
                    
                    <div class="info-item">
                        <strong>Precio:</strong><br>
                        <span class="h5 text-success">${{ invitacion.costo_servicio|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Cronología
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline-item completed">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Invitación Creada</strong>
                                <p class="mb-0 text-muted">La invitación fue generada exitosamente</p>
                            </div>
                            <small class="text-muted">{{ invitacion.fecha_creacion|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    
                    {% if invitacion.fecha_utilizacion %}
                    <div class="timeline-item completed">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Registro Completado</strong>
                                <p class="mb-0 text-muted">El cliente completó el registro de su parcela</p>
                            </div>
                            <small class="text-muted">{{ invitacion.fecha_utilizacion|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% elif invitacion.esta_expirada %}
                    <div class="timeline-item expired">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Invitación Expirada</strong>
                                <p class="mb-0 text-muted">La invitación venció sin ser utilizada</p>
                            </div>
                            <small class="text-muted">{{ invitacion.fecha_expiracion|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="timeline-item pending">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>Esperando Respuesta</strong>
                                <p class="mb-0 text-muted">El cliente aún no ha completado el registro</p>
                            </div>
                            <small class="text-muted">Expira el {{ invitacion.fecha_expiracion|date:"d/m/Y" }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Enlace de Invitación -->
            {% if not invitacion.fecha_utilizacion and not invitacion.esta_expirada %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-share-alt me-2"></i>
                        Compartir Invitación
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Botones de envío -->
                    <div class="d-grid gap-2 mb-3">
                        {% if invitacion.email_cliente %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" name="enviar_email" class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-envelope me-2"></i>
                                Enviar por Email
                            </button>
                        </form>
                        {% endif %}
                        
                        <button class="btn btn-success btn-sm w-100" 
                                onclick="abrirWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>
                            Enviar por WhatsApp
                        </button>
                    </div>
                    
                    <!-- Enlace para copiar -->
                    <div class="mt-3">
                        <label class="form-label small">Enlace de invitación:</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="enlace-invitacion"
                                   value="{{ url_completa }}" 
                                   readonly>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="copiarEnlace('{{ url_completa }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Información de Token -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-key me-2"></i>
                        Información Técnica
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Token:</small><br>
                        <code class="small">{{ invitacion.token }}</code>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">ID:</small><br>
                        <span class="small">#{{ invitacion.id }}</span>
                    </div>
                    
                    <div>
                        <small class="text-muted">Creado por:</small><br>
                        <span class="small">{{ invitacion.creado_por.get_full_name|default:invitacion.creado_por.username }}</span>
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Acciones
                    </h6>
                </div>
                <div class="card-body">
                    {% if invitacion.fecha_utilizacion %}
                        <a href="#" class="btn btn-outline-primary btn-sm w-100 mb-2">
                            <i class="fas fa-eye me-2"></i>
                            Ver Parcela Registrada
                        </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" 
                            onclick="window.print()">
                        <i class="fas fa-print me-2"></i>
                        Imprimir Detalle
                    </button>
                    
                    {% if not invitacion.fecha_utilizacion and not invitacion.esta_expirada %}
                    <button class="btn btn-outline-info btn-sm w-100" 
                            onclick="mostrarMensajeWhatsApp()">
                        <i class="fas fa-eye me-2"></i>
                        Ver Mensaje WhatsApp
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const mensajeWhatsApp = `{{ mensaje_whatsapp|escapejs }}`;

function copiarEnlace(url) {
    navigator.clipboard.writeText(url).then(function() {
        // Crear notificación temporal
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = '<i class="fas fa-check me-2"></i>Enlace copiado al portapapeles';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}

function abrirWhatsApp() {
    const url = `https://wa.me/?text=${encodeURIComponent(mensajeWhatsApp)}`;
    window.open(url, '_blank');
}

function mostrarMensajeWhatsApp() {
    // Crear modal con el mensaje
    const modalHtml = `
        <div class="modal fade" id="whatsappModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>
                            Mensaje para WhatsApp
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <small>Copia este mensaje y pégalo en WhatsApp para enviarlo al cliente:</small>
                        </div>
                        <textarea class="form-control" rows="10" readonly id="mensajeWhatsApp">${mensajeWhatsApp}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="copiarMensajeWhatsApp()">
                            <i class="fas fa-copy me-2"></i>Copiar Mensaje
                        </button>
                        <button type="button" class="btn btn-primary" onclick="abrirWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM si no existe
    if (!document.getElementById('whatsappModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
    modal.show();
}

function copiarMensajeWhatsApp() {
    const mensaje = document.getElementById('mensajeWhatsApp').value;
    navigator.clipboard.writeText(mensaje).then(function() {
        // Crear notificación temporal
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = '<i class="fas fa-check me-2"></i>Mensaje copiado al portapapeles';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}
</script>
{% endblock %}