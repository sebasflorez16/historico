{% extends 'informes/base.html' %}
{% load static %}

{% block title %}Dashboard de Estad√≠sticas EOSDA{% endblock %}

{% block extra_css %}
<style>
    .stats-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .stat-card-title {
        font-size: 1.3em;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-card-icon {
        font-size: 2em;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .metric-box {
        flex: 1;
        min-width: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .metric-box.success {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .metric-box.info {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }
    
    .metric-box.warning {
        background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    }
    
    .metric-value {
        font-size: 2.5em;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .metric-label {
        font-size: 1em;
        opacity: 0.9;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin: 20px 0;
    }
    
    .filter-bar {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 25px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-bar select {
        padding: 10px 15px;
        border-radius: 5px;
        border: 1px solid #ddd;
        font-size: 1em;
    }
    
    .filter-bar button {
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .filter-bar button:hover {
        background: #45a049;
    }
    
    .parcela-list {
        list-style: none;
        padding: 0;
    }
    
    .parcela-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s ease;
    }
    
    .parcela-item:hover {
        background: #f8f9fa;
    }
    
    .parcela-item:last-child {
        border-bottom: none;
    }
    
    .parcela-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .parcela-stats {
        color: #666;
        font-size: 0.9em;
    }
    
    .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        display: inline-block;
    }
    
    .badge-success {
        background: #4CAF50;
        color: white;
    }
    
    .badge-info {
        background: #2196F3;
        color: white;
    }
    
    .badge-warning {
        background: #FF9800;
        color: white;
    }
    
    .cache-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f1f8f4;
        border-left: 4px solid #4CAF50;
        border-radius: 5px;
        margin: 15px 0;
    }
    
    .cache-indicator .icon {
        font-size: 2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <div class="page-header">
        <h1>üìä Dashboard de Estad√≠sticas EOSDA</h1>
        <p class="text-muted">Monitoreo de uso, costos y rendimiento del sistema</p>
    </div>
    
    <!-- Filtros -->
    <div class="filter-bar">
        <label style="font-weight: bold;">üìÖ Periodo:</label>
        <select id="dias-filtro" onchange="filtrarPeriodo(this.value)">
            {% for opcion in periodo_opciones %}
            <option value="{{ opcion }}" {% if opcion == dias_filtro %}selected{% endif %}>
                {% if opcion == 7 %}√öltima semana
                {% elif opcion == 30 %}√öltimo mes
                {% elif opcion == 90 %}√öltimos 3 meses
                {% elif opcion == 180 %}√öltimos 6 meses
                {% elif opcion == 365 %}√öltimo a√±o
                {% endif %}
            </option>
            {% endfor %}
        </select>
        <button onclick="location.reload()">üîÑ Actualizar</button>
    </div>
    
    <!-- M√©tricas Generales -->
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-card-title">üìà Resumen General</span>
            <span class="stat-card-icon">üí°</span>
        </div>
        
        <div class="metric-row">
            <div class="metric-box">
                <div class="metric-label">Total Operaciones</div>
                <div class="metric-value">{{ stats_generales.total_operaciones }}</div>
            </div>
            
            <div class="metric-box success">
                <div class="metric-label">Requests Consumidos</div>
                <div class="metric-value">{{ stats_generales.total_requests }}</div>
            </div>
            
            <div class="metric-box info">
                <div class="metric-label">Desde Cach√©</div>
                <div class="metric-value">{{ stats_generales.desde_cache }}</div>
            </div>
            
            <div class="metric-box warning">
                <div class="metric-label">Ahorro</div>
                <div class="metric-value">{{ ahorro_porcentaje }}%</div>
            </div>
        </div>
        
        <div class="cache-indicator">
            <span class="icon">‚ö°</span>
            <div>
                <strong>Eficiencia del Sistema:</strong> 
                Con el cach√© inteligente has ahorrado aproximadamente 
                <strong>{{ ahorro_porcentaje }}%</strong> en requests a EOSDA.
                {% if stats_generales.total_requests > 0 %}
                Tiempo promedio de respuesta: <strong>{{ stats_generales.tiempo_promedio|floatformat:2 }}s</strong>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de Requests por D√≠a -->
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-card-title">üìÖ Requests por D√≠a</span>
            <span class="stat-card-icon">üìä</span>
        </div>
        <div class="chart-container">
            <canvas id="requestsChart"></canvas>
        </div>
        <p class="text-muted text-center">
            Verde = Desde cach√© (0 requests), Rojo = Desde API (consumo real)
        </p>
    </div>
    
    <div class="row">
        <!-- Distribuci√≥n por Tipo -->
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">üîÑ Por Tipo de Operaci√≥n</span>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="tipoChart"></canvas>
                </div>
                
                <div style="margin-top: 20px;">
                    {% for tipo in por_tipo %}
                    <div class="parcela-item">
                        <div>
                            <span class="parcela-name">{{ tipo.tipo_operacion }}</span>
                        </div>
                        <div class="parcela-stats">
                            <span class="badge badge-info">{{ tipo.total }} ops</span>
                            <span class="badge badge-success">{{ tipo.requests }} req</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No hay datos disponibles</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Top Parcelas -->
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">üå± Top 5 Parcelas Consultadas</span>
                </div>
                
                <ul class="parcela-list">
                    {% for parcela in top_parcelas %}
                    <li class="parcela-item">
                        <div>
                            <div class="parcela-name">{{ parcela.parcela__nombre }}</div>
                            <div class="parcela-stats">
                                {{ parcela.total_consultas }} consultas ‚Ä¢ 
                                {{ parcela.total_requests }} requests
                            </div>
                        </div>
                        <a href="{% url 'informes:detalle_parcela' parcela.parcela__id %}" 
                           class="btn btn-sm btn-outline-success">
                            Ver ‚Üí
                        </a>
                    </li>
                    {% empty %}
                    <li class="text-muted text-center" style="padding: 30px;">
                        No hay datos de parcelas a√∫n
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Estado del Cach√© -->
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-card-title">üíæ Estado del Cach√©</span>
            <span class="stat-card-icon">üóÑÔ∏è</span>
        </div>
        
        <div class="metric-row">
            <div class="metric-box info">
                <div class="metric-label">Registros Activos</div>
                <div class="metric-value">{{ cache_stats.total_registros }}</div>
            </div>
            
            <div class="metric-box success">
                <div class="metric-label">Promedio Escenas</div>
                <div class="metric-value">{{ cache_stats.tama√±o_promedio|floatformat:1 }}</div>
            </div>
            
            {% if cache_stats.mas_usado %}
            <div class="metric-box warning">
                <div class="metric-label">M√°s Reutilizado</div>
                <div class="metric-value">{{ cache_stats.mas_usado.veces_usado }}x</div>
                <div class="metric-label" style="font-size: 0.8em; margin-top: 5px;">
                    Field: {{ cache_stats.mas_usado.field_id }}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="cache-indicator" style="margin-top: 20px;">
            <span class="icon">üí°</span>
            <div>
                <strong>Tip:</strong> 
                El cach√© se mantiene v√°lido por 7 d√≠as. Los datos m√°s consultados se reutilizan
                autom√°ticamente, ahorrando tiempo y requests. 
                {% if cache_stats.total_registros > 10 %}
                <br>Tienes <strong>{{ cache_stats.total_registros }} registros</strong> en cach√© activo.
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
// Datos desde Django
const graficosData = {{ graficos_json|safe }};

// Configuraci√≥n de colores del tema
const colors = {
    primary: 'rgba(76, 175, 80, 0.8)',
    secondary: 'rgba(255, 99, 132, 0.8)',
    info: 'rgba(33, 150, 243, 0.8)',
    warning: 'rgba(255, 152, 0, 0.8)',
    purple: 'rgba(102, 126, 234, 0.8)'
};

// Gr√°fico de Requests por D√≠a
const ctxRequests = document.getElementById('requestsChart').getContext('2d');
new Chart(ctxRequests, {
    type: 'bar',
    data: {
        labels: graficosData.requests_timeline.labels,
        datasets: graficosData.requests_timeline.datasets.map((dataset, idx) => ({
            ...dataset,
            backgroundColor: idx === 0 ? colors.secondary : colors.primary,
            borderWidth: 0,
            borderRadius: 8
        }))
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: { size: 14 },
                    padding: 15
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 }
            }
        },
        scales: {
            x: {
                stacked: true,
                grid: { display: false }
            },
            y: {
                stacked: true,
                beginAtZero: true,
                ticks: { stepSize: 1 }
            }
        }
    }
});

// Gr√°fico de Distribuci√≥n por Tipo
const ctxTipo = document.getElementById('tipoChart').getContext('2d');
new Chart(ctxTipo, {
    type: 'doughnut',
    data: {
        labels: graficosData.por_tipo.labels,
        datasets: [{
            data: graficosData.por_tipo.data,
            backgroundColor: [
                colors.primary,
                colors.info,
                colors.warning,
                colors.secondary,
                colors.purple
            ],
            borderWidth: 3,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    font: { size: 13 },
                    padding: 10
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const requests = graficosData.por_tipo.requests[context.dataIndex] || 0;
                        return `${label}: ${value} ops (${requests} req)`;
                    }
                }
            }
        }
    }
});

function filtrarPeriodo(dias) {
    window.location.href = '?dias=' + dias;
}
</script>
{% endblock %}
