{% extends "informes/base.html" %}
{% load static %}

{% block title %}{{ parcela.nombre }} - Detalle Parcela{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* ========================================
       üåø DETALLE PARCELA - NEUM√ìRFICO LUMINOSO
       ======================================== */
    
    .parcela-header {
        background: var(--neuro-bg-secondary);
        color: var(--agrotech-green);
        padding: 40px;
        border-radius: 32px;
        margin-bottom: 40px;
        box-shadow: var(--neuro-shadow-light), var(--neuro-shadow-dark);
        position: relative;
        overflow: hidden;
        transition: all 0.4s ease;
    }
    
    .parcela-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--agrotech-green), var(--agrotech-orange));
    }
    
    .parcela-header:hover {
        transform: translateY(-4px);
        box-shadow: var(--neuro-shadow-hover-light), var(--neuro-shadow-hover-dark);
    }
    
    .parcela-header h1 {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .parcela-header h1 i {
        padding: 16px;
        background: var(--neuro-bg-primary);
        border-radius: 20px;
        box-shadow: var(--neuro-shadow-light), var(--neuro-shadow-dark);
        color: var(--agrotech-orange);
    }
    
    .parcela-header p {
        margin-bottom: 12px;
        font-size: 1.05rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .parcela-header strong {
        color: var(--agrotech-green);
    }
    
    /* Cards de informaci√≥n neum√≥rficos */
    .info-card {
        background: var(--neuro-bg-secondary);
        border-radius: 28px;
        box-shadow: var(--neuro-shadow-light), var(--neuro-shadow-dark);
        margin-bottom: 30px;
        overflow: visible;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .info-card::before {
        content: '';
        position: absolute;
        top: -2px;
        left: 20px;
        right: 20px;
        height: 5px;
        background: linear-gradient(90deg, var(--agrotech-green), var(--agrotech-orange));
        border-radius: 28px 28px 0 0;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--neuro-shadow-hover-light), var(--neuro-shadow-hover-dark);
    }
    
    .info-card:hover::before {
        opacity: 1;
    }
    
    .info-card-header {
        background: linear-gradient(145deg, 
            rgba(46, 139, 87, 0.08), 
            rgba(255, 122, 0, 0.08));
        color: var(--agrotech-green);
        padding: 24px 28px;
        font-weight: 800;
        border-radius: 28px 28px 0 0;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.3rem;
    }
    
    .info-card-header i {
        color: var(--agrotech-orange);
        font-size: 1.4rem;
    }
    
    .info-card-body {
        padding: 32px;
    }
    
    /* Cajas de estad√≠sticas neum√≥rficas */
    .stat-box {
        text-align: center;
        padding: 28px;
        border-radius: 24px;
        background: var(--neuro-bg-primary);
        margin-bottom: 20px;
        box-shadow: inset -4px -4px 8px rgba(255, 255, 255, 0.7),
                    inset 4px 4px 8px rgba(46, 139, 87, 0.1);
        transition: all 0.3s ease;
    }
    
    .stat-box:hover {
        transform: scale(1.05);
        box-shadow: inset -6px -6px 12px rgba(255, 255, 255, 0.8),
                    inset 6px 6px 12px rgba(46, 139, 87, 0.15);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--agrotech-green);
        display: block;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(46, 139, 87, 0.2);
    }
    
    .stat-label {
        font-size: 1rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
    }
    
    /* Grupos de botones responsive */
    .btn-group-responsive {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .btn-group-responsive .btn {
        flex: 1 1 auto;
        min-width: 180px;
    }
    
    /* Badge mejorado */
    .badge {
        padding: 10px 18px;
        border-radius: 16px;
        font-weight: 700;
        font-size: 0.9rem;
        box-shadow: var(--neuro-shadow-light), var(--neuro-shadow-dark);
    }
    
    /* Mapa neum√≥rfico */
    #mapa-detalle {
        height: 450px;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: var(--neuro-shadow-light), var(--neuro-shadow-dark);
        transition: all 0.3s ease;
    }
    
    #mapa-detalle:hover {
        box-shadow: var(--neuro-shadow-hover-light), var(--neuro-shadow-hover-dark);
    }
    
    /* Responsive para detalle de parcela */
    @media (max-width: 991px) {
        .parcela-header h1 {
            font-size: 1.8rem;
        }
        
        .btn-group-responsive {
            flex-direction: column;
        }
        
        .btn-group-responsive .btn {
            width: 100%;
            min-width: 100%;
        }
    }
    
    @media (max-width: 768px) {
        .parcela-header {
            padding: 24px;
            border-radius: 24px;
        }
        
        .parcela-header h1 {
            font-size: 1.5rem;
            flex-direction: column;
            text-align: center;
        }
        
        .info-card {
            margin-bottom: 20px;
        }
        
        .info-card-header {
            font-size: 1.1rem;
            padding: 18px 20px;
        }
        
        .info-card-body {
            padding: 20px;
        }
        
        .stat-box {
            padding: 20px;
        }
        
        .stat-number {
            font-size: 2rem;
        }
        
        #mapa-detalle {
            height: 350px;
        }
    }
    
    @media (max-width: 576px) {
        .parcela-header {
            padding: 20px;
            border-radius: 20px;
        }
        
        .parcela-header h1 {
            font-size: 1.3rem;
        }
        
        .parcela-header h1 i {
            padding: 12px;
            font-size: 1.2rem;
        }
        
        .info-card-header {
            font-size: 1rem;
            padding: 16px 18px;
        }
        
        .stat-number {
            font-size: 1.8rem;
        }
        
        .stat-label {
            font-size: 0.85rem;
        }
        
        #mapa-detalle {
            height: 280px;
            border-radius: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la parcela -->
    <div class="parcela-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-map-marked-alt"></i> {{ parcela.nombre }}</h1>
                <p class="mb-2"><strong>Propietario:</strong> {{ parcela.propietario }}</p>
                <p class="mb-0"><strong>Tipo de Cultivo:</strong> {{ parcela.tipo_cultivo|default:"No especificado" }}</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex flex-column gap-2 mb-3">
                    <a href="{% url 'informes:lista_parcelas' %}" class="btn btn-light">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
                
                <div class="btn-group-responsive">
                    {% if parcela.eosda_sincronizada %}
                        <a href="{% url 'informes:obtener_datos_historicos' parcela.id %}" class="btn btn-success" 
                           title="Obtener datos satelitales reales desde EOSDA">
                            <i class="fas fa-satellite"></i> Datos EOSDA
                        </a>
                        <span class="btn btn-outline-success" title="Sincronizada con EOSDA Field ID: {{ parcela.eosda_field_id }}">
                            <i class="fas fa-check-circle"></i> Sincronizada
                        </span>
                    {% else %}
                        <a href="{% url 'informes:sincronizar_con_eosda' parcela.id %}" class="btn btn-warning" 
                           title="Sincronizar parcela con EOSDA primero">
                            <i class="fas fa-sync-alt"></i> Sincronizar EOSDA
                        </a>
                    {% endif %}
                    <a href="{% url 'informes:ver_datos_guardados' parcela.id %}" class="btn btn-info"
                       title="Ver datos hist√≥ricos guardados">
                        <i class="fas fa-database"></i> Datos Guardados
                    </a>
                    <a href="#" class="btn btn-primary">
                        <i class="fas fa-file-download"></i> Generar Informe
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Informaci√≥n general -->
        <div class="col-md-4">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-info-circle"></i> Informaci√≥n General
                </div>
                <div class="info-card-body">
                    <div class="stat-box">
                        <span class="stat-number">{{ parcela.area_hectareas|floatformat:2 }}</span>
                        <span class="stat-label">Hect√°reas</span>
                    </div>
                    
                    <div class="stat-box">
                        <span class="stat-number">{{ parcela.perimetro_metros|floatformat:0 }}</span>
                        <span class="stat-label">Metros de Per√≠metro</span>
                    </div>
                    
                    <p><strong>Fecha de Registro:</strong><br>{{ parcela.fecha_registro|date:"d/m/Y H:i" }}</p>
                    <p><strong>Inicio Monitoreo:</strong><br>{{ parcela.fecha_inicio_monitoreo|date:"d/m/Y" }}</p>
                    <p><strong>Estado:</strong><br>
                        <span class="badge bg-{% if parcela.activa %}success{% else %}secondary{% endif %}">
                            {% if parcela.activa %}Activa{% else %}Inactiva{% endif %}
                        </span>
                    </p>
                    
                    <!-- Estado EOSDA -->
                    <p><strong>Estado EOSDA:</strong><br>
                        {% if parcela.eosda_sincronizada %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Sincronizada
                            </span>
                            {% if parcela.eosda_field_id %}
                                <small class="text-muted d-block mt-1">
                                    Field ID: {{ parcela.eosda_field_id|truncatechars:20 }}
                                </small>
                            {% endif %}
                            {% if parcela.eosda_fecha_sincronizacion %}
                                <small class="text-muted d-block">
                                    Sync: {{ parcela.eosda_fecha_sincronizacion|date:"d/m/Y H:i" }}
                                </small>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">
                                <i class="fas fa-exclamation"></i> Pendiente
                            </span>
                            {% if parcela.eosda_errores %}
                                <small class="text-danger d-block mt-1">
                                    Error: {{ parcela.eosda_errores|truncatechars:50 }}
                                </small>
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>

            {% if parcela.invitacion_cliente %}
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-user"></i> Informaci√≥n del Cliente
                </div>
                <div class="info-card-body">
                    <p><strong>Cliente:</strong> {{ parcela.invitacion_cliente.nombre_cliente }}</p>
                    {% if parcela.invitacion_cliente.email_cliente %}
                    <p><strong>Email:</strong> {{ parcela.invitacion_cliente.email_cliente }}</p>
                    {% endif %}
                    {% if parcela.invitacion_cliente.telefono_cliente %}
                    <p><strong>Tel√©fono:</strong> {{ parcela.invitacion_cliente.telefono_cliente }}</p>
                    {% endif %}
                    <p><strong>Costo Servicio:</strong> ${{ parcela.invitacion_cliente.costo_servicio|floatformat:2 }}</p>
                    <p><strong>Estado Pago:</strong>
                        <span class="badge bg-{% if parcela.invitacion_cliente.pagado %}success{% else %}warning{% endif %}">
                            {% if parcela.invitacion_cliente.pagado %}Pagado{% else %}Pendiente{% endif %}
                        </span>
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Mapa -->
        <div class="col-md-8">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-globe"></i> Ubicaci√≥n y Geometr√≠a
                </div>
                <div class="info-card-body">
                    <div id="mapa-detalle" class="mapa-detalle"></div>
                </div>
            </div>

            {% if parcela.notas %}
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-sticky-note"></i> Notas Adicionales
                </div>
                <div class="info-card-body">
                    <pre style="white-space: pre-wrap;">{{ parcela.notas }}</pre>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Registros econ√≥micos si existen -->
    {% if registros_economicos %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-dollar-sign"></i> Registros Econ√≥micos
                </div>
                <div class="info-card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo Servicio</th>
                                    <th>Descripci√≥n</th>
                                    <th>Valor</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registro in registros_economicos %}
                                <tr>
                                    <td>{{ registro.fecha_servicio|date:"d/m/Y" }}</td>
                                    <td>{{ registro.get_tipo_servicio_display }}</td>
                                    <td>{{ registro.descripcion|truncatechars:50 }}</td>
                                    <td>${{ registro.valor_final|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge bg-{% if registro.pagado %}success{% else %}warning{% endif %}">
                                            {% if registro.pagado %}Pagado{% else %}Pendiente{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando carga del mapa de detalle de parcela...');
    
    // Verificar datos del servidor con manejo seguro de tipos
    const centroLatRaw = '{{ centro_lat|default:"" }}';
    const centroLonRaw = '{{ centro_lon|default:"" }}';
    
    const centroLat = centroLatRaw !== '' ? parseFloat(centroLatRaw) : null;
    const centroLon = centroLonRaw !== '' ? parseFloat(centroLonRaw) : null;
    const geometriaRaw = '{{ parcela.poligono_geojson|safe|escapejs }}';
    
    console.log('Centro lat raw:', centroLatRaw, '-> parsed:', centroLat);
    console.log('Centro lon raw:', centroLonRaw, '-> parsed:', centroLon);
    console.log('GeoJSON raw:', geometriaRaw.substring(0, 100) + '...');
    
    // Verificar que tenemos datos v√°lidos
    if (centroLat !== null && centroLon !== null && !isNaN(centroLat) && !isNaN(centroLon)) {
        try {
            // Inicializar mapa con coordenadas v√°lidas
            console.log('Inicializando mapa en:', [centroLat, centroLon]);
            const mapaDetalle = L.map('mapa-detalle').setView([centroLat, centroLon], 15);
            
            // Capa satelital
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 19,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE4Ij5TaW4gaW1hZ2VuPC90ZXh0Pjwvc3ZnPg=='
            }).addTo(mapaDetalle);
            
            // Procesar geometr√≠a si existe
            if (geometriaRaw && geometriaRaw.trim() !== '') {
                try {
                    const geometriaParcela = JSON.parse(geometriaRaw);
                    console.log('Geometr√≠a parseada:', geometriaParcela);
                    
                    if (geometriaParcela && (geometriaParcela.type === 'Polygon' || (geometriaParcela.geometry && geometriaParcela.geometry.type === 'Polygon'))) {
                        // Manejar tanto GeoJSON directo como Feature
                        const geoJsonData = geometriaParcela.geometry ? geometriaParcela : {
                            type: "Feature",
                            geometry: geometriaParcela,
                            properties: {
                                name: "{{ parcela.nombre|escapejs }}"
                            }
                        };
                        
                        const parcelaLayer = L.geoJSON(geoJsonData, {
                            style: {
                                color: '#e65100',           // Naranja oscuro para el borde
                                weight: 4,                  // Borde m√°s grueso
                                opacity: 0.9,              // Borde m√°s visible
                                fillOpacity: 0.4,          // Relleno m√°s visible
                                fillColor: '#ff9800',      // Naranja brillante para relleno
                                dashArray: '5, 5'          // L√≠nea discontinua para mejor visibilidad
                            },
                            onEachFeature: function(feature, layer) {
                                // Efecto hover para interactividad
                                layer.on({
                                    mouseover: function(e) {
                                        const layer = e.target;
                                        layer.setStyle({
                                            weight: 5,
                                            color: '#bf360c',
                                            fillOpacity: 0.6,
                                            fillColor: '#ffab40'
                                        });
                                    },
                                    mouseout: function(e) {
                                        const layer = e.target;
                                        layer.setStyle({
                                            color: '#e65100',
                                            weight: 4,
                                            opacity: 0.9,
                                            fillOpacity: 0.4,
                                            fillColor: '#ff9800'
                                        });
                                    }
                                });
                            }
                        }).addTo(mapaDetalle);
                        
                        // Ajustar vista al pol√≠gono con padding
                        if (parcelaLayer.getBounds && parcelaLayer.getBounds().isValid()) {
                            mapaDetalle.fitBounds(parcelaLayer.getBounds(), { padding: [20, 20] });
                        }
                        
                        // Agregar popup con informaci√≥n
                        parcelaLayer.bindPopup(`
                            <div style="text-align: center; min-width: 200px;">
                                <h6 style="color: #4a5d23; margin-bottom: 10px;">{{ parcela.nombre|escapejs }}</h6>
                                <p><strong>√Årea:</strong> {{ parcela.area_hectareas|floatformat:2 }} ha</p>
                                <p><strong>Propietario:</strong> {{ parcela.propietario|escapejs }}</p>
                                <p><strong>Tipo:</strong> {{ parcela.tipo_cultivo|default:"No especificado"|escapejs }}</p>
                            </div>
                        `);
                        
                        console.log('‚úÖ Geometr√≠a de parcela cargada correctamente');
                        
                    } else {
                        console.error('‚ùå Formato de geometr√≠a no v√°lido:', geometriaParcela);
                        throw new Error('Formato de geometr√≠a no v√°lido');
                    }
                } catch (parseError) {
                    console.error('‚ùå Error al parsear GeoJSON:', parseError);
                    throw parseError;
                }
            } else {
                console.warn('‚ö†Ô∏è No hay datos de geometr√≠a disponibles');
                // Agregar marcador en el centro
                L.marker([centroLat, centroLon]).addTo(mapaDetalle)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h6>{{ parcela.nombre|escapejs }}</h6>
                            <p><strong>‚ö†Ô∏è Geometr√≠a no disponible</strong></p>
                            <p>Solo se muestra la ubicaci√≥n aproximada</p>
                        </div>
                    `);
            }
            
        } catch (error) {
            console.error('‚ùå Error en inicializaci√≥n del mapa:', error);
            // Fallback: mostrar mensaje de error en el contenedor
            document.getElementById('mapa-detalle').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
                    <div style="text-align: center; color: #6c757d;">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="color: #ffc107;"></i>
                        <h6>Error cargando el mapa</h6>
                        <p>No se pudo cargar la visualizaci√≥n del mapa.<br>Verifique la conexi√≥n a internet.</p>
                        <small>Error: ${error.message}</small>
                    </div>
                </div>
            `;
        }
    } else {
        console.error('‚ùå Coordenadas del centro no v√°lidas:', { centroLat, centroLon });
        // Mostrar mapa por defecto de Colombia
        const mapaDetalle = L.map('mapa-detalle').setView([4.5709, -74.2973], 6);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri',
            maxZoom: 19
        }).addTo(mapaDetalle);
        
        // Mostrar mensaje de error
        L.popup()
            .setLatLng([4.5709, -74.2973])
            .setContent(`
                <div style="text-align: center;">
                    <strong>‚ùå Error de coordenadas</strong><br>
                    No se pudieron cargar las coordenadas de la parcela.<br>
                    <small>Centro lat: ${centroLat}, lon: ${centroLon}</small>
                </div>
            `)
            .openOn(mapaDetalle);
    }
});
</script>
{% endblock %}