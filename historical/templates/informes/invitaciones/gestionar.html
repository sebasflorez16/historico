{% extends 'informes/base.html' %}
{% load static %}

{% block title %}Gestión de Invitaciones - AgroTech Histórico{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #2d5016 0%, #4a8234 100%);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #2d5016 0%, #4a8234 100%);
        border: none;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #1a3009 0%, #2d5016 100%);
    }
    
    .badge-success { background: #4a8234; }
    .badge-warning { background: #f39c12; }
    .badge-danger { background: #e74c3c; }
    
    .stats-card {
        border-left: 4px solid #4a8234;
    }
    
    .invitation-item {
        transition: all 0.3s ease;
    }
    
    .invitation-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 text-dark">
                    <i class="fas fa-envelope-open-text me-2"></i>
                    Gestión de Invitaciones
                </h1>
                <a href="{% url 'informes:crear_invitacion' %}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Nueva Invitación
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-1">Total Invitaciones</h5>
                            <h3 class="text-primary">{{ estadisticas.total_invitaciones }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-envelope fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-1">Pendientes</h5>
                            <h3 class="text-warning">{{ estadisticas.pendientes }}</h3>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-1">Completadas</h5>
                            <h3 class="text-success">{{ estadisticas.utilizadas }}</h3>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title text-muted mb-1">Expiradas</h5>
                            <h3 class="text-danger">{{ estadisticas.expiradas }}</h3>
                        </div>
                        <div class="text-danger">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Invitaciones -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Invitaciones Recientes
            </h5>
        </div>
        <div class="card-body">
            {% if invitaciones %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Email</th>
                                <th>Fecha Envío</th>
                                <th>Vencimiento</th>
                                <th>Estado</th>
                                <th>Servicio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invitacion in invitaciones %}
                            <tr class="invitation-item">
                                <td>
                                    <strong>{{ invitacion.nombre_cliente }}</strong>
                                </td>
                                <td>{{ invitacion.email_cliente }}</td>
                                <td>{{ invitacion.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                <td>{{ invitacion.fecha_expiracion|date:"d/m/Y" }}</td>
                                <td>
                                    {% if invitacion.esta_expirada %}
                                        <span class="badge badge-danger">Expirada</span>
                                    {% elif invitacion.fecha_utilizacion %}
                                        <span class="badge badge-success">Completada</span>
                                    {% else %}
                                        <span class="badge badge-warning">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-muted">${{ invitacion.costo_servicio|floatformat:2 }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'informes:detalle_invitacion' invitacion.id %}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not invitacion.fecha_utilizacion and not invitacion.esta_expirada %}
                                    <button class="btn btn-sm btn-outline-success" 
                                            onclick="copiarEnlace('{{ request.build_absolute_uri }}{% url 'informes:registro_invitacion' invitacion.token %}')"
                                            title="Copiar enlace">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay invitaciones registradas</h5>
                    <p class="text-muted">Crea tu primera invitación para comenzar</p>
                    <a href="{% url 'informes:crear_invitacion' %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Nueva Invitación
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copiarEnlace(url) {
    navigator.clipboard.writeText(url).then(function() {
        // Crear notificación temporal
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = '<i class="fas fa-check me-2"></i>Enlace copiado al portapapeles';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    });
}
</script>
{% endblock %}