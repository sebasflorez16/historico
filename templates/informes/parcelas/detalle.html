{% extends "informes/base.html" %}
{% load static %}

{% block title %}{{ parcela.nombre }} - Detalle Parcela{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .parcela-header {
        background: linear-gradient(135deg, #4a5d23 0%, #6b8f47 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .info-card-header {
        background: #4a5d23;
        color: white;
        padding: 15px 20px;
        font-weight: 600;
    }
    
    .info-card-body {
        padding: 20px;
    }
    
    .stat-box {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #4a5d23;
        display: block;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .mapa-detalle {
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la parcela -->
    <div class="parcela-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-map-marked-alt"></i> {{ parcela.nombre }}</h1>
                <p class="mb-2"><strong>Propietario:</strong> {{ parcela.propietario }}</p>
                <p class="mb-0"><strong>Tipo de Cultivo:</strong> {{ parcela.tipo_cultivo|default:"No especificado" }}</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'informes:lista_parcelas' %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <div class="btn-group" role="group">
                    {% if parcela.eosda_sincronizada %}
                        <a href="{% url 'informes:obtener_datos_historicos' parcela.id %}" class="btn btn-success" 
                           title="Obtener datos satelitales reales desde EOSDA">
                            <i class="fas fa-satellite"></i> Datos EOSDA
                        </a>
                        <span class="btn btn-outline-success" title="Sincronizada con EOSDA Field ID: {{ parcela.eosda_field_id }}">
                            <i class="fas fa-check"></i> Sincronizada
                        </span>
                    {% else %}
                        <a href="{% url 'informes:sincronizar_con_eosda' parcela.id %}" class="btn btn-warning" 
                           title="Sincronizar parcela con EOSDA primero">
                            <i class="fas fa-sync"></i> Sincronizar EOSDA
                        </a>
                    {% endif %}
                    <a href="{% url 'informes:ver_datos_guardados' parcela.id %}" class="btn btn-info"
                       title="Ver datos históricos guardados">
                        <i class="fas fa-database"></i> Datos Guardados
                    </a>
                    <a href="#" class="btn btn-success">
                        <i class="fas fa-download"></i> Generar Informe
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información general -->
        <div class="col-md-4">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-info-circle"></i> Información General
                </div>
                <div class="info-card-body">
                    <div class="stat-box">
                        <span class="stat-number">{{ parcela.area_hectareas|floatformat:2 }}</span>
                        <span class="stat-label">Hectáreas</span>
                    </div>
                    
                    <div class="stat-box">
                        <span class="stat-number">{{ parcela.perimetro_metros|floatformat:0 }}</span>
                        <span class="stat-label">Metros de Perímetro</span>
                    </div>
                    
                    <p><strong>Fecha de Registro:</strong><br>{{ parcela.fecha_registro|date:"d/m/Y H:i" }}</p>
                    <p><strong>Inicio Monitoreo:</strong><br>{{ parcela.fecha_inicio_monitoreo|date:"d/m/Y" }}</p>
                    <p><strong>Estado:</strong><br>
                        <span class="badge bg-{% if parcela.activa %}success{% else %}secondary{% endif %}">
                            {% if parcela.activa %}Activa{% else %}Inactiva{% endif %}
                        </span>
                    </p>
                    
                    <!-- Estado EOSDA -->
                    <p><strong>Estado EOSDA:</strong><br>
                        {% if parcela.eosda_sincronizada %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Sincronizada
                            </span>
                            {% if parcela.eosda_field_id %}
                                <small class="text-muted d-block mt-1">
                                    Field ID: {{ parcela.eosda_field_id|truncatechars:20 }}
                                </small>
                            {% endif %}
                            {% if parcela.eosda_fecha_sincronizacion %}
                                <small class="text-muted d-block">
                                    Sync: {{ parcela.eosda_fecha_sincronizacion|date:"d/m/Y H:i" }}
                                </small>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">
                                <i class="fas fa-exclamation"></i> Pendiente
                            </span>
                            {% if parcela.eosda_errores %}
                                <small class="text-danger d-block mt-1">
                                    Error: {{ parcela.eosda_errores|truncatechars:50 }}
                                </small>
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>

            {% if parcela.invitacion_cliente %}
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-user"></i> Información del Cliente
                </div>
                <div class="info-card-body">
                    <p><strong>Cliente:</strong> {{ parcela.invitacion_cliente.nombre_cliente }}</p>
                    {% if parcela.invitacion_cliente.email_cliente %}
                    <p><strong>Email:</strong> {{ parcela.invitacion_cliente.email_cliente }}</p>
                    {% endif %}
                    {% if parcela.invitacion_cliente.telefono_cliente %}
                    <p><strong>Teléfono:</strong> {{ parcela.invitacion_cliente.telefono_cliente }}</p>
                    {% endif %}
                    <p><strong>Costo Servicio:</strong> ${{ parcela.invitacion_cliente.costo_servicio|floatformat:2 }}</p>
                    <p><strong>Estado Pago:</strong>
                        <span class="badge bg-{% if parcela.invitacion_cliente.pagado %}success{% else %}warning{% endif %}">
                            {% if parcela.invitacion_cliente.pagado %}Pagado{% else %}Pendiente{% endif %}
                        </span>
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Mapa -->
        <div class="col-md-8">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-globe"></i> Ubicación y Geometría
                </div>
                <div class="info-card-body">
                    <div id="mapa-detalle" class="mapa-detalle"></div>
                </div>
            </div>

            {% if parcela.notas %}
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-sticky-note"></i> Notas Adicionales
                </div>
                <div class="info-card-body">
                    <pre style="white-space: pre-wrap;">{{ parcela.notas }}</pre>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Registros económicos si existen -->
    {% if registros_economicos %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="fas fa-dollar-sign"></i> Registros Económicos
                </div>
                <div class="info-card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo Servicio</th>
                                    <th>Descripción</th>
                                    <th>Valor</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registro in registros_economicos %}
                                <tr>
                                    <td>{{ registro.fecha_servicio|date:"d/m/Y" }}</td>
                                    <td>{{ registro.get_tipo_servicio_display }}</td>
                                    <td>{{ registro.descripcion|truncatechars:50 }}</td>
                                    <td>${{ registro.valor_final|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge bg-{% if registro.pagado %}success{% else %}warning{% endif %}">
                                            {% if registro.pagado %}Pagado{% else %}Pendiente{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando carga del mapa de detalle de parcela...');
    
    // Verificar datos del servidor con manejo seguro de tipos
    const centroLatRaw = '{{ centro_lat|default:"" }}';
    const centroLonRaw = '{{ centro_lon|default:"" }}';
    
    const centroLat = centroLatRaw !== '' ? parseFloat(centroLatRaw) : null;
    const centroLon = centroLonRaw !== '' ? parseFloat(centroLonRaw) : null;
    const geometriaRaw = '{{ parcela.poligono_geojson|safe|escapejs }}';
    
    console.log('Centro lat raw:', centroLatRaw, '-> parsed:', centroLat);
    console.log('Centro lon raw:', centroLonRaw, '-> parsed:', centroLon);
    console.log('GeoJSON raw:', geometriaRaw.substring(0, 100) + '...');
    
    // Verificar que tenemos datos válidos
    if (centroLat !== null && centroLon !== null && !isNaN(centroLat) && !isNaN(centroLon)) {
        try {
            // Inicializar mapa con coordenadas válidas
            console.log('Inicializando mapa en:', [centroLat, centroLon]);
            const mapaDetalle = L.map('mapa-detalle').setView([centroLat, centroLon], 15);
            
            // Capa satelital
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri',
                maxZoom: 19,
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE4Ij5TaW4gaW1hZ2VuPC90ZXh0Pjwvc3ZnPg=='
            }).addTo(mapaDetalle);
            
            // Procesar geometría si existe
            if (geometriaRaw && geometriaRaw.trim() !== '') {
                try {
                    const geometriaParcela = JSON.parse(geometriaRaw);
                    console.log('Geometría parseada:', geometriaParcela);
                    
                    if (geometriaParcela && (geometriaParcela.type === 'Polygon' || (geometriaParcela.geometry && geometriaParcela.geometry.type === 'Polygon'))) {
                        // Manejar tanto GeoJSON directo como Feature
                        const geoJsonData = geometriaParcela.geometry ? geometriaParcela : {
                            type: "Feature",
                            geometry: geometriaParcela,
                            properties: {
                                name: "{{ parcela.nombre|escapejs }}"
                            }
                        };
                        
                        const parcelaLayer = L.geoJSON(geoJsonData, {
                            style: {
                                color: '#e65100',           // Naranja oscuro para el borde
                                weight: 4,                  // Borde más grueso
                                opacity: 0.9,              // Borde más visible
                                fillOpacity: 0.4,          // Relleno más visible
                                fillColor: '#ff9800',      // Naranja brillante para relleno
                                dashArray: '5, 5'          // Línea discontinua para mejor visibilidad
                            },
                            onEachFeature: function(feature, layer) {
                                // Efecto hover para interactividad
                                layer.on({
                                    mouseover: function(e) {
                                        const layer = e.target;
                                        layer.setStyle({
                                            weight: 5,
                                            color: '#bf360c',
                                            fillOpacity: 0.6,
                                            fillColor: '#ffab40'
                                        });
                                    },
                                    mouseout: function(e) {
                                        const layer = e.target;
                                        layer.setStyle({
                                            color: '#e65100',
                                            weight: 4,
                                            opacity: 0.9,
                                            fillOpacity: 0.4,
                                            fillColor: '#ff9800'
                                        });
                                    }
                                });
                            }
                        }).addTo(mapaDetalle);
                        
                        // Ajustar vista al polígono con padding
                        if (parcelaLayer.getBounds && parcelaLayer.getBounds().isValid()) {
                            mapaDetalle.fitBounds(parcelaLayer.getBounds(), { padding: [20, 20] });
                        }
                        
                        // Agregar popup con información
                        parcelaLayer.bindPopup(`
                            <div style="text-align: center; min-width: 200px;">
                                <h6 style="color: #4a5d23; margin-bottom: 10px;">{{ parcela.nombre|escapejs }}</h6>
                                <p><strong>Área:</strong> {{ parcela.area_hectareas|floatformat:2 }} ha</p>
                                <p><strong>Propietario:</strong> {{ parcela.propietario|escapejs }}</p>
                                <p><strong>Tipo:</strong> {{ parcela.tipo_cultivo|default:"No especificado"|escapejs }}</p>
                            </div>
                        `);
                        
                        console.log('✅ Geometría de parcela cargada correctamente');
                        
                    } else {
                        console.error('❌ Formato de geometría no válido:', geometriaParcela);
                        throw new Error('Formato de geometría no válido');
                    }
                } catch (parseError) {
                    console.error('❌ Error al parsear GeoJSON:', parseError);
                    throw parseError;
                }
            } else {
                console.warn('⚠️ No hay datos de geometría disponibles');
                // Agregar marcador en el centro
                L.marker([centroLat, centroLon]).addTo(mapaDetalle)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h6>{{ parcela.nombre|escapejs }}</h6>
                            <p><strong>⚠️ Geometría no disponible</strong></p>
                            <p>Solo se muestra la ubicación aproximada</p>
                        </div>
                    `);
            }
            
        } catch (error) {
            console.error('❌ Error en inicialización del mapa:', error);
            // Fallback: mostrar mensaje de error en el contenedor
            document.getElementById('mapa-detalle').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
                    <div style="text-align: center; color: #6c757d;">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="color: #ffc107;"></i>
                        <h6>Error cargando el mapa</h6>
                        <p>No se pudo cargar la visualización del mapa.<br>Verifique la conexión a internet.</p>
                        <small>Error: ${error.message}</small>
                    </div>
                </div>
            `;
        }
    } else {
        console.error('❌ Coordenadas del centro no válidas:', { centroLat, centroLon });
        // Mostrar mapa por defecto de Colombia
        const mapaDetalle = L.map('mapa-detalle').setView([4.5709, -74.2973], 6);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri',
            maxZoom: 19
        }).addTo(mapaDetalle);
        
        // Mostrar mensaje de error
        L.popup()
            .setLatLng([4.5709, -74.2973])
            .setContent(`
                <div style="text-align: center;">
                    <strong>❌ Error de coordenadas</strong><br>
                    No se pudieron cargar las coordenadas de la parcela.<br>
                    <small>Centro lat: ${centroLat}, lon: ${centroLon}</small>
                </div>
            `)
            .openOn(mapaDetalle);
    }
});
</script>
{% endblock %}