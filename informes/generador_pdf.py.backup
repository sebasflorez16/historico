"""
Generador de Informes en PDF Profesionales
Sistema completo de generaci√≥n de reportes satelitales con logos AgroTech
"""
import os
import re
from datetime import datetime, date
from typing import Dict, List, Any, Optional
from io import BytesIO
from dateutil.relativedelta import relativedelta

# ReportLab imports
from reportlab.lib.pagesizes import A4, letter
from reportlab.lib.units import cm, inch
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_CENTER, TA_JUSTIFY, TA_LEFT, TA_RIGHT
from reportlab.platypus import (
    SimpleDocTemplate, Paragraph, Spacer, Image, PageBreak, 
    Table, TableStyle, KeepTogether, Frame, PageTemplate
)
from reportlab.pdfgen import canvas

# Matplotlib para gr√°ficos (usar backend no-GUI para evitar problemas con threads)
import matplotlib
matplotlib.use('Agg')  # ‚úÖ Backend no-GUI, seguro para threads y servidores web
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from matplotlib.figure import Figure
import seaborn as sns

# Django imports
from django.conf import settings

# Modelos locales
from informes.models import Parcela, IndiceMensual

# Analizadores
from informes.analizadores.ndvi_analyzer import AnalizadorNDVI
from informes.analizadores.ndmi_analyzer import AnalizadorNDMI
from informes.analizadores.savi_analyzer import AnalizadorSAVI
from informes.analizadores.tendencias_analyzer import DetectorTendencias
from informes.analizadores.recomendaciones_engine import GeneradorRecomendaciones

import logging
logger = logging.getLogger(__name__)


def limpiar_html_completo(texto: str) -> str:
    """
    Limpia HTML COMPLETAMENTE - convierte a formato ReportLab sin tags visibles
    
    Usa enfoque de 3 pasos:
    1. Convertir tags deseados a marcadores temporales
    2. Eliminar TODOS los tags HTML restantes  
    3. Restaurar solo los tags necesarios en formato ReportLab
    """
    if not texto:
        return ""
    
    # Convertir a string
    texto = str(texto)
    
    # Limpieza agresiva de strong mal formados
    texto = re.sub(r'<strong>\s*</strong>', '', texto)  # Eliminar strong vac√≠os
    texto = re.sub(r'<strong>([^<]*?)(?=<strong>|$)', r'<b>\1</b>', texto)  # strong sin cerrar
    
    # Normalizar <strong> a <b> y </strong> a </b> para evitar duplicidad y errores
    texto = texto.replace('<strong>', '<b>').replace('</strong>', '</b>')
    # PASO 1: Reemplazar tags que queremos mantener con marcadores temporales
    replacements = {
        '<b>': '**BOLD_START**',
        '</b>': '**BOLD_END**',
        '<em>': '**ITALIC_START**',
        '</em>': '**ITALIC_END**',
        '<i>': '**ITALIC_START**',
        '</i>': '**ITALIC_END**',
        '<br>': '**LINEBREAK**',
        '<br/>': '**LINEBREAK**',
        '<BR>': '**LINEBREAK**',
    }
    for old, new in replacements.items():
        texto = texto.replace(old, new)
    
    # PASO 2: Eliminar CUALQUIER tag HTML que quede (regex agresivo)
    texto = re.sub(r'<[^>]+>', '', texto)
    
    # PASO 3: Restaurar los tags que queremos en formato ReportLab
    texto = texto.replace('**BOLD_START**', '<b>')
    texto = texto.replace('**BOLD_END**', '</b>')
    texto = texto.replace('**ITALIC_START**', '<i>')
    texto = texto.replace('**ITALIC_END**', '</i>')
    texto = texto.replace('**LINEBREAK**', '<br/>')
    
    # PASO 4: Limpiar saltos de l√≠nea
    texto = texto.replace('\n\n', '<br/><br/>')
    texto = texto.replace('\n', ' ')
    
    # PASO 5: Formatear bullets
    texto = re.sub(r'‚Ä¢\s*', '<br/>  ‚Ä¢ ', texto)
    texto = re.sub(r'\*\s+', '<br/>  ‚Ä¢ ', texto)
    
    # PASO 6: Limpiar espacios m√∫ltiples
    texto = re.sub(r'\s+', ' ', texto)
    texto = re.sub(r'(<br/>\s*){3,}', '<br/><br/>', texto)
    
    return texto.strip()


class GeneradorPDFProfesional:
    """
    Genera informes PDF profesionales con:
    - Logos AgroTech
    - An√°lisis inteligente de √≠ndices
    - Gr√°ficos matplotlib
    - Recomendaciones accionables
    - Dise√±o moderno y profesional
    """
    
    def __init__(self):
        self.pagesize = A4
        self.ancho, self.alto = A4
        self.margen = 2*cm
        
        # Colores corporativos AgroTech
        self.colores = {
            'verde_principal': colors.HexColor('#2E8B57'),  # Verde AgroTech
            'verde_claro': colors.HexColor('#90EE90'),
            'naranja': colors.HexColor('#FF7A00'),
            'azul': colors.HexColor('#17a2b8'),
            'gris_oscuro': colors.HexColor('#2c3e50'),
            'gris_claro': colors.HexColor('#ecf0f1'),
        }
        
        # Estilos
        self.estilos = self._crear_estilos()
    
    def _obtener_path_imagen_correcto(self, imagen_field):
        """
        Obtiene el path correcto de una imagen, manejando paths relativos y absolutos
        """
        if not imagen_field:
            return None
        
        try:
            # Obtener el path string del campo
            path_str = str(imagen_field).strip()
            
            if not path_str:
                return None
            
            # Lista de paths a probar en orden de prioridad
            paths_a_probar = []
            
            # 1. Intentar obtener .path del campo ImageField
            try:
                if hasattr(imagen_field, 'path'):
                    paths_a_probar.append(imagen_field.path)
            except:
                pass
            
            # 2. Si es una ruta relativa (como imagenes_satelitales/2025/12/ndvi/...)
            if not path_str.startswith('/'):
                # Construir desde MEDIA_ROOT
                if hasattr(settings, 'MEDIA_ROOT'):
                    path_desde_media = os.path.join(settings.MEDIA_ROOT, path_str)
                    paths_a_probar.append(path_desde_media)
                
                # Construir desde BASE_DIR/media
                path_desde_base = os.path.join(settings.BASE_DIR, 'media', path_str)
                paths_a_probar.append(path_desde_base)
            
            # 3. Si contiene historical/media, corregir a media
            if 'historical/media' in path_str:
                path_corregido = path_str.replace('historical/media/', 'media/')
                paths_a_probar.append(path_corregido)
                
                path_absoluto = os.path.join(settings.BASE_DIR, path_corregido)
                paths_a_probar.append(path_absoluto)
            
            # 4. Path absoluto directo
            if path_str.startswith('/'):
                paths_a_probar.append(path_str)
            
            # Probar cada path hasta encontrar uno que exista
            for path in paths_a_probar:
                if path and os.path.exists(path):
                    return path
            
            # Si ninguno existe, retornar None
            return None
            
        except Exception as e:
            logger.warning(f"Error obteniendo path de imagen: {e}")
            return None
    
    def formato_mes_a√±o_espa√±ol(self, fecha: date) -> str:
        """Formatea fecha en espa√±ol (Enero 2025)"""
        meses = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
        return f"{meses[fecha.month]} {fecha.year}"
    
    def _decorar_seccion(self, img_name, height=1.2*cm):
        """Devuelve una banda decorativa para usar como separador de secciones"""
        from reportlab.platypus import Image
        img_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', img_name)
        if os.path.exists(img_path):
            try:
                banda = Image(img_path, width=15*cm, height=height, kind='proportional')
                banda.hAlign = 'CENTER'
                return [banda, Spacer(1, 0.2*cm)]
            except Exception as e:
                logger.warning(f"No se pudo cargar banda decorativa {img_name}: {e}")
        return []

    def _crear_estilos(self):
        """Crea estilos personalizados para el documento"""
        estilos = getSampleStyleSheet()
        
        # T√≠tulo de portada
        estilos.add(ParagraphStyle(
            name='TituloPortada',
            parent=estilos['Heading1'],
            fontSize=28,
            textColor=self.colores['verde_principal'],
            spaceAfter=30,
            alignment=TA_CENTER,
            fontName='Helvetica-Bold'
        ))
        
        # Subt√≠tulo de portada
        estilos.add(ParagraphStyle(
            name='SubtituloPortada',
            parent=estilos['Normal'],
            fontSize=16,
            textColor=self.colores['gris_oscuro'],
            spaceAfter=12,
            alignment=TA_CENTER,
            fontName='Helvetica'
        ))
        
        # T√≠tulo de secci√≥n
        estilos.add(ParagraphStyle(
            name='TituloSeccion',
            parent=estilos['Heading1'],
            fontSize=18,
            textColor=self.colores['verde_principal'],
            spaceBefore=24,
            spaceAfter=12,
            fontName='Helvetica-Bold',
            borderColor=self.colores['verde_principal'],
            borderWidth=2,
            borderPadding=8
        ))
        
        # Subt√≠tulo de secci√≥n
        estilos.add(ParagraphStyle(
            name='SubtituloSeccion',
            parent=estilos['Heading2'],
            fontSize=14,
            textColor=self.colores['azul'],
            spaceBefore=16,
            spaceAfter=8,
            fontName='Helvetica-Bold'
        ))
        
        # Texto normal
        estilos.add(ParagraphStyle(
            name='TextoNormal',
            parent=estilos['Normal'],
            fontSize=11,
            textColor=self.colores['gris_oscuro'],
            spaceAfter=12,
            alignment=TA_JUSTIFY,
            fontName='Helvetica'
        ))
        
        # An√°lisis t√©cnico (fuente mejorada)
        estilos.add(ParagraphStyle(
            name='AnalisisTecnico',
            parent=estilos['Normal'],
            fontSize=12,
            leading=18,
            textColor=self.colores['gris_oscuro'],
            spaceAfter=14,
            alignment=TA_JUSTIFY,
            fontName='Helvetica',
            leftIndent=10,
            rightIndent=10
        ))
        
        # Pie de imagen
        estilos.add(ParagraphStyle(
            name='PieImagen',
            parent=estilos['Normal'],
            fontSize=9,
            textColor=colors.grey,
            alignment=TA_CENTER,
            fontName='Helvetica-Oblique'
        ))
        
        return estilos
    
    def generar_informe_completo(self, parcela_id: int, 
                                meses_atras: int = 12,
                                output_path: str = None) -> str:
        """
        Genera informe completo en PDF
        
        Args:
            parcela_id: ID de la parcela
            meses_atras: Per√≠odo de an√°lisis (meses)
            output_path: Ruta de salida del PDF (opcional)
        
        Returns:
            Ruta del archivo PDF generado
        """
        # Obtener parcela
        try:
            parcela = Parcela.objects.get(id=parcela_id, activa=True)
        except Parcela.DoesNotExist:
            raise ValueError(f"Parcela {parcela_id} no encontrada")
        
        # Obtener datos hist√≥ricos - PERIODO REAL SEG√öN DATOS DISPONIBLES
        indices = IndiceMensual.objects.filter(parcela=parcela).order_by('a√±o', 'mes')
        if not indices.exists():
            raise ValueError(f"No hay datos disponibles para la parcela {parcela.nombre}")
        fecha_inicio = date(indices.first().a√±o, indices.first().mes, 1)
        fecha_fin = date(indices.last().a√±o, indices.last().mes, 1)
        
        # Preparar datos para an√°lisis
        datos_analisis = self._preparar_datos_analisis(indices)
        
        # Ejecutar an√°lisis (pasando los √≠ndices originales para cach√©)
        analisis_completo = self._ejecutar_analisis(datos_analisis, parcela, indices)
        
        # Generar gr√°ficos
        graficos = self._generar_graficos(datos_analisis)
        
        # Crear PDF
        if not output_path:
            nombre_archivo = f"informe_{parcela.nombre.replace(' ', '_')}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
            output_path = os.path.join(settings.MEDIA_ROOT, 'informes', nombre_archivo)
        
        # Asegurar que existe el directorio
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        
        # Construir documento
        doc = SimpleDocTemplate(
            output_path,
            pagesize=self.pagesize,
            rightMargin=self.margen,
            leftMargin=self.margen,
            topMargin=self.margen + 1*cm,  # Espacio para header
            bottomMargin=self.margen + 0.5*cm  # Espacio para footer
        )
        
        # Contenido del documento
        story = []
        
        # Portada
        story.extend(self._crear_portada(parcela, fecha_inicio, fecha_fin))
        story.append(PageBreak())
        
        # Resumen ejecutivo
        story.extend(self._crear_resumen_ejecutivo(analisis_completo))
        story.append(Spacer(1, 0.5*cm))
        story.append(PageBreak())
        
        # üì∏ Galer√≠a de Im√°genes Satelitales (si hay im√°genes disponibles)
        story.extend(self._crear_galeria_imagenes_satelitales(
            parcela, indices
        ))
        story.append(PageBreak())
        
        # Informaci√≥n de la parcela
        story.extend(self._crear_info_parcela(parcela))
        story.append(Spacer(1, 1*cm))
        
        # An√°lisis de √≠ndices
        story.extend(self._crear_seccion_ndvi(analisis_completo['ndvi'], graficos))
        story.append(PageBreak())
        
        story.extend(self._crear_seccion_ndmi(analisis_completo['ndmi'], graficos))
        story.append(PageBreak())
        
        if 'savi' in analisis_completo and analisis_completo['savi']:
            story.extend(self._crear_seccion_savi(analisis_completo['savi'], graficos))
            story.append(PageBreak())
        
        # An√°lisis de tendencias
        story.extend(self._crear_seccion_tendencias(analisis_completo['tendencias'], graficos))
        story.append(PageBreak())
        
        # Recomendaciones
        story.extend(self._crear_seccion_recomendaciones(analisis_completo['recomendaciones']))
        story.append(PageBreak())
        
        # Tabla de datos
        story.extend(self._crear_tabla_datos(datos_analisis))
        story.append(PageBreak())
        
        # P√°gina de cr√©ditos
        story.extend(self._crear_pagina_creditos())
        
        # Construir PDF con headers y footers
        doc.build(story, onFirstPage=self._crear_header_footer, 
                 onLaterPages=self._crear_header_footer)
        
        return output_path
    
    def _preparar_datos_analisis(self, indices: List[IndiceMensual]) -> List[Dict]:
        """Prepara datos en formato para an√°lisis"""
        datos = []
        for indice in indices:
            datos.append({
                'mes': f"{indice.a√±o}-{indice.mes:02d}",
                'periodo': indice.periodo_texto,
                'ndvi': indice.ndvi_promedio,
                'ndmi': indice.ndmi_promedio,
                'savi': indice.savi_promedio,
                'nubosidad_promedio': indice.nubosidad_promedio,
                'temperatura': indice.temperatura_promedio,
                'precipitacion': indice.precipitacion_total
            })
        return datos
    
    def _ejecutar_analisis(self, datos: List[Dict], parcela: Parcela, indices: List) -> Dict:
        """Ejecuta todos los an√°lisis, incluyendo Gemini AI"""
        # Inicializar analizadores especializados
        analizador_ndvi = AnalizadorNDVI(tipo_cultivo=parcela.tipo_cultivo)
        analizador_ndmi = AnalizadorNDMI(tipo_cultivo=parcela.tipo_cultivo)
        analizador_savi = AnalizadorSAVI(tipo_cultivo=parcela.tipo_cultivo)
        detector_tendencias = DetectorTendencias()
        generador_recomendaciones = GeneradorRecomendaciones(tipo_cultivo=parcela.tipo_cultivo)
        
        # Ejecutar an√°lisis especializados con motores dedicados
        analisis_ndvi = analizador_ndvi.analizar(datos)
        analisis_ndmi = analizador_ndmi.analizar(datos)
        analisis_savi = analizador_savi.analizar(datos) if any(d.get('savi') for d in datos) else None
        
        # An√°lisis de tendencias temporales
        tendencias = detector_tendencias.analizar_temporal(datos, 'ndvi')
        
        # Generaci√≥n de recomendaciones agron√≥micas
        recomendaciones = generador_recomendaciones.generar_recomendaciones(
            analisis_ndvi, analisis_ndmi, analisis_savi, tendencias
        )
        
        return {
            'ndvi': analisis_ndvi,
            'ndmi': analisis_ndmi,
            'savi': analisis_savi,
            'tendencias': tendencias,
            'recomendaciones': recomendaciones
        }
    
    def _generar_graficos(self, datos: List[Dict]) -> Dict[str, BytesIO]:
        """Genera todos los gr√°ficos necesarios"""
        graficos = {}
        
        # Gr√°fico de evoluci√≥n temporal
        graficos['evolucion_temporal'] = self._grafico_evolucion_temporal(datos)
        
        # Gr√°fico comparativo
        graficos['comparativo'] = self._grafico_comparativo(datos)
        
        return graficos
    
    def _grafico_evolucion_temporal(self, datos: List[Dict]) -> BytesIO:
        """Genera gr√°fico de evoluci√≥n temporal con contexto hist√≥rico"""
        fig, ax = plt.subplots(figsize=(12, 6))
        
        # Configurar estilo
        sns.set_style("whitegrid")
        
        # Extraer datos
        meses = [d['periodo'] for d in datos]
        ndvi = [d.get('ndvi', 0) for d in datos]
        ndmi = [d.get('ndmi', 0) for d in datos]
        savi = [d.get('savi', 0) for d in datos]
        
        # Calcular per√≠odo para el t√≠tulo
        if meses:
            periodo_inicio = meses[0]
            periodo_fin = meses[-1]
            titulo_con_periodo = f'Evoluci√≥n Hist√≥rica de √çndices - Per√≠odo {periodo_inicio} a {periodo_fin}'
        else:
            titulo_con_periodo = 'Evoluci√≥n Temporal de √çndices de Vegetaci√≥n'
        
        # Graficar
        ax.plot(meses, ndvi, marker='o', linewidth=2.5, color='#2E8B57', label='NDVI = Vigor vegetal (salud y biomasa)', markersize=6)
        ax.plot(meses, ndmi, marker='s', linewidth=2.5, color='#17a2b8', label='NDMI = Contenido de humedad', markersize=6)
        if any(savi):
            ax.plot(meses, savi, marker='^', linewidth=2.5, color='#FF7A00', label='SAVI = Cobertura vegetal real', markersize=6)
        
        # Configurar
        ax.set_xlabel('Per√≠odo Mensual', fontsize=12, fontweight='bold')
        ax.set_ylabel('Valor del √çndice', fontsize=12, fontweight='bold')
        ax.set_title(titulo_con_periodo, 
                     fontsize=13, fontweight='bold', color='#2c3e50')
        ax.legend(loc='best', fontsize=9, framealpha=0.95, edgecolor='gray')
        ax.grid(True, alpha=0.3, linestyle='--')
        
        # Rotar etiquetas
        plt.xticks(rotation=45, ha='right')
        plt.tight_layout()
        
        # Guardar en buffer
        buffer = BytesIO()
        plt.savefig(buffer, format='png', dpi=150, bbox_inches='tight')
        buffer.seek(0)
        plt.close()
        
        return buffer
    
    def _grafico_comparativo(self, datos: List[Dict]) -> BytesIO:
        """Genera gr√°fico de barras comparativo con explicaciones claras"""
        fig, ax = plt.subplots(figsize=(10, 6))
        
        # Calcular promedios (filtrar None)
        ndvi_valores = [d.get('ndvi') for d in datos if d.get('ndvi') is not None]
        ndmi_valores = [d.get('ndmi') for d in datos if d.get('ndmi') is not None]
        savi_valores = [d.get('savi') for d in datos if d.get('savi') is not None]
        
        ndvi_prom = sum(ndvi_valores) / len(ndvi_valores) if ndvi_valores else 0
        ndmi_prom = sum(ndmi_valores) / len(ndmi_valores) if ndmi_valores else 0
        savi_prom = sum(savi_valores) / len(savi_valores) if savi_valores else 0
        
        num_meses = len(datos)
        
        indices = ['NDVI\n(Vigor vegetal)', 'NDMI\n(Humedad)', 'SAVI\n(Cobertura real)']
        valores = [ndvi_prom, ndmi_prom, savi_prom]
        colores_barra = ['#2E8B57', '#17a2b8', '#FF7A00']
        
        # Crear barras
        bars = ax.bar(indices, valores, color=colores_barra, alpha=0.8, edgecolor='black', linewidth=1.5)
        
        # A√±adir valores encima de las barras
        for bar, valor in zip(bars, valores):
            height = bar.get_height()
            ax.text(bar.get_x() + bar.get_width()/2., height,
                   f'{valor:.3f}',
                   ha='center', va='bottom', fontsize=12, fontweight='bold')
        
        ax.set_ylabel('Valor Promedio Hist√≥rico', fontsize=12, fontweight='bold')
        ax.set_title(f'Promedios de √çndices durante el Per√≠odo Analizado ({num_meses} meses)', 
                    fontsize=13, fontweight='bold', color='#2c3e50')
        ax.set_ylim(0, max(valores) * 1.2 if valores else 1)
        ax.grid(axis='y', alpha=0.3)
        
        # Nota explicativa
        nota = 'Estos valores representan el promedio hist√≥rico de cada √≠ndice durante todo el per√≠odo'
        fig.text(0.5, 0.02, nota, ha='center', fontsize=9, style='italic', color='gray')
        
        plt.tight_layout(rect=[0, 0.03, 1, 1])  # Dejar espacio para la nota
        
        buffer = BytesIO()
        plt.savefig(buffer, format='png', dpi=150, bbox_inches='tight')
        buffer.seek(0)
        plt.close()
        
        return buffer
    
    def _crear_portada(self, parcela: Parcela, fecha_inicio: date, fecha_fin: date) -> List:
        """Crea la portada del informe con dise√±o profesional estilo EOSDA"""
        from reportlab.lib.utils import ImageReader
        elements = []
        # === IMAGEN DE FONDO DECORATIVA (1.png) ===
        img_fondo_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', '1.png')
        if os.path.exists(img_fondo_path):
            try:
                img_fondo = Image(img_fondo_path, width=15*cm, height=8*cm, kind='proportional')
                img_fondo.hAlign = 'CENTER'
                elements.append(img_fondo)
                elements.append(Spacer(1, 0.5*cm))
            except Exception as e:
                logger.warning(f"No se pudo cargar imagen de portada: {e}")
        else:
            elements.append(Spacer(1, 2*cm))
        
        # === LOGO AGROTECH GRANDE ===
        logo_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'Agro Tech logo solo.png')
        if not os.path.exists(logo_path):
            # Alternativa con texto
            logo_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'agrotech solo negro.png')
        
        if os.path.exists(logo_path):
            try:
                logo = Image(logo_path, width=8*cm, height=8*cm, kind='proportional')
                logo.hAlign = 'CENTER'
                elements.append(logo)
                elements.append(Spacer(1, 0.8*cm))
            except Exception as e:
                logger.warning(f"No se pudo cargar logo: {e}")
                titulo_logo = Paragraph(
                    '<font size="24" color="#2E8B57"><strong>agrotech</strong></font>',
                    self.estilos['TituloPortada']
                )
                elements.append(titulo_logo)
                elements.append(Spacer(1, 0.5*cm))
        
        # === T√çTULO PRINCIPAL MODERNO (sin imagen aqu√≠, se usa en otras secciones) ===
        titulo_principal = Paragraph(
            '<para align="center">'
            '<font size="22" color="#2E8B57"><strong>An√°lisis Satelital de Precisi√≥n</strong></font>'
            '</para>',
            self.estilos['TituloPortada']
        )
        elements.append(titulo_principal)
        elements.append(Spacer(1, 0.3*cm))
        
        subtitulo = Paragraph(
            '<para align="center">'
            '<font size="14" color="#555555"><i>Sistema Inteligente de Monitoreo Agr√≠cola</i></font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(subtitulo)
        elements.append(Spacer(1, 1.2*cm))
        
        # === CARD FLOTANTE MINIMALISTA CON INFO ===
        info_card_data = [
            ['Parcela', parcela.nombre],
            ['Cultivo', parcela.tipo_cultivo or 'No especificado'],
            ['Extensi√≥n', f"{parcela.area_hectareas:.2f} hect√°reas"],
            ['Per√≠odo', f"{self.formato_mes_a√±o_espa√±ol(fecha_inicio)} - {self.formato_mes_a√±o_espa√±ol(fecha_fin)}"]
        ]
        
        tabla_card = Table(info_card_data, colWidths=[4.5*cm, 8*cm])
        tabla_card.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
            ('FONTNAME', (1, 0), (1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 11),
            ('TEXTCOLOR', (0, 0), (0, -1), colors.white),
            ('TEXTCOLOR', (1, 0), (1, -1), colors.HexColor('#2c3e50')),
            ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#2E8B57')),
            ('BACKGROUND', (1, 0), (1, -1), colors.white),
            ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#2E8B57')),
            ('LINEBELOW', (0, 0), (-1, -2), 0.5, colors.HexColor('#E0E0E0')),
            ('TOPPADDING', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
            ('LEFTPADDING', (0, 0), (0, -1), 15),
            ('RIGHTPADDING', (0, 0), (0, -1), 10),
            ('LEFTPADDING', (1, 0), (1, -1), 15),
        ]))
        
        # Centrar la card
        from reportlab.platypus import KeepTogether
        tabla_card.hAlign = 'CENTER'
        elements.append(tabla_card)
        elements.append(Spacer(1, 2*cm))
        
        # === PIE DE PORTADA MINIMALISTA ===
        pie = Paragraph(
            '<para align="center">'
            '<font size="9" color="#888888">'
            'Informe generado autom√°ticamente ¬∑ Tecnolog√≠a Satelital EOSDA<br/>'
            f'<strong>{datetime.now().strftime("%d de %B de %Y")}</strong>'
            '</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(pie)
        return elements
        def _decorar_seccion(self, img_name, height=1.2*cm):
            """Devuelve una banda decorativa para usar como separador de secciones"""
            from reportlab.platypus import Image
            img_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', img_name)
            if os.path.exists(img_path):
                try:
                    banda = Image(img_path, width=15*cm, height=height, kind='proportional')
                    banda.hAlign = 'CENTER'
                    return [banda, Spacer(1, 0.2*cm)]
                except Exception as e:
                    logger.warning(f"No se pudo cargar banda decorativa {img_name}: {e}")
            return []
    
    def _crear_header_footer(self, canvas_obj, doc):
        """Crea header y footer en cada p√°gina"""
        canvas_obj.saveState()
        
        # Header - Logo peque√±o
        logo_path = os.path.join(settings.STATIC_ROOT or settings.BASE_DIR, 'static', 'img', 'favicon.svg')
        if os.path.exists(logo_path):
            try:
                canvas_obj.drawImage(logo_path, self.margen, self.alto - self.margen + 0.5*cm, 
                                   width=1*cm, height=1*cm, preserveAspectRatio=True)
            except:
                pass
        
        # Header - Texto
        canvas_obj.setFont('Helvetica', 9)
        canvas_obj.setFillColor(self.colores['gris_oscuro'])
        canvas_obj.drawString(self.margen + 1.5*cm, self.alto - self.margen + 0.7*cm, 
                            "AgroTech - An√°lisis Satelital Agr√≠cola")
        
        # Footer - N√∫mero de p√°gina
        canvas_obj.setFont('Helvetica', 9)
        canvas_obj.drawCentredString(self.ancho / 2, self.margen / 2, 
                                     f"P√°gina {doc.page}")
        
        # Footer - Fecha
        canvas_obj.drawRightString(self.ancho - self.margen, self.margen / 2,
                                  datetime.now().strftime('%d/%m/%Y'))
        
        canvas_obj.restoreState()
    
    # Contin√∫o en el siguiente mensaje con las secciones del informe...
    
    def _crear_resumen_ejecutivo(self, analisis: Dict) -> List:
        """Crea resumen ejecutivo del informe, priorizando an√°lisis de Gemini AI"""
        elements = []
        # Decoraci√≥n superior (5.png)
        elements.extend(self._decorar_seccion('5.png', height=1*cm))
        # T√≠tulo
        titulo = Paragraph("üìä Resumen Ejecutivo", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # ü§ñ SI HAY AN√ÅLISIS DE GEMINI, USARLO
        if analisis.get('gemini') and not analisis['gemini'].get('error'):
            gemini_data = analisis['gemini']
            
            # A√±adir indicador de an√°lisis IA
            badge_ia = Paragraph(
                '<para alignment="right"><font color="#17a2b8"><b>ü§ñ An√°lisis generado con Gemini AI</b></font></para>',
                self.estilos['TextoNormal']
            )
            elements.append(badge_ia)
            elements.append(Spacer(1, 0.3*cm))
            
            # Resumen ejecutivo de Gemini
            resumen_gemini = gemini_data.get('resumen_ejecutivo', '')
            if resumen_gemini:
                # Limpiar y formatear texto
                resumen_texto = resumen_gemini.replace('\n', '<br/>')
                resumen_texto = limpiar_html_completo(resumen_texto)
                
                resumen = Paragraph(resumen_texto, self.estilos['TextoNormal'])
                elements.append(resumen)
                elements.append(Spacer(1, 0.5*cm))
            
            # Agregar m√©tricas b√°sicas tradicionales como complemento
            ndvi_punt = analisis['ndvi'].get('puntuacion', 0)
            ndmi_punt = analisis['ndmi'].get('puntuacion', 0)
            promedio_general = (ndvi_punt + ndmi_punt) / 2
            
            metricas_complemento = f"""
<para alignment="left"><font size="9" color="#666666">
<b>M√©tricas Cuantitativas:</b><br/>
‚Ä¢ Puntuaci√≥n General: {promedio_general:.1f}/10<br/>
‚Ä¢ NDVI: {analisis['ndvi']['estadisticas']['promedio']:.3f} ({analisis['ndvi']['estado']['etiqueta']})<br/>
‚Ä¢ NDMI: {analisis['ndmi']['estadisticas']['promedio']:.3f} ({analisis['ndmi']['estado']['etiqueta']})<br/>
‚Ä¢ Tendencia: {analisis['tendencias'].get('tendencia_lineal', {}).get('direccion', 'estable').title()} 
  ({analisis['tendencias'].get('tendencia_lineal', {}).get('cambio_porcentual', 0):+.1f}%)
</font></para>
"""
            complemento = Paragraph(metricas_complemento, self.estilos['TextoNormal'])
            elements.append(complemento)
            
        else:
            # FALLBACK: Usar an√°lisis tradicional mejorado y din√°mico
            if analisis.get('gemini') and analisis['gemini'].get('error'):
                logger.warning(f"‚ö†Ô∏è Error en Gemini, usando an√°lisis tradicional mejorado")
            
            # Calcular valores del per√≠odo completo
            from informes.models import IndiceMensual
            indices_periodo = IndiceMensual.objects.filter(
                parcela=analisis.get('parcela')
            ).order_by('-a√±o', '-mes') if analisis.get('parcela') else []
            
            temp_valores = [idx.temperatura_promedio for idx in indices_periodo if idx.temperatura_promedio]
            precip_valores = [idx.precipitacion_total for idx in indices_periodo if idx.precipitacion_total]
            
            temp_prom_periodo = sum(temp_valores) / len(temp_valores) if temp_valores else None
            precip_total_periodo = sum(precip_valores) if precip_valores else None
            
            # Puntuaciones tradicionales
            ndvi_punt = analisis['ndvi'].get('puntuacion', 0)
            ndmi_punt = analisis['ndmi'].get('puntuacion', 0)
            promedio_general = (ndvi_punt + ndmi_punt) / 2
            
            # Identificar alertas cr√≠ticas
            alertas_criticas = [r for r in analisis['recomendaciones'] if r['prioridad'] == 'alta']
            tiene_alertas = len(alertas_criticas) > 0
            
            # Texto din√°mico basado en condiciones reales
            if promedio_general >= 8:
                conclusion = "El cultivo presenta <b>excelente estado general</b> en el per√≠odo analizado."
            elif promedio_general >= 6:
                conclusion = "El cultivo muestra <b>buen desempe√±o</b> con algunas √°reas de mejora identificadas."
            elif promedio_general >= 4:
                conclusion = "El cultivo presenta <b>estado moderado</b> que requiere atenci√≥n en ciertas √°reas."
            else:
                conclusion = "El cultivo muestra <b>signos de estr√©s</b> que requieren intervenci√≥n inmediata."
            
            resumen_texto = f"""
<b>üìä ESTADO DEL CULTIVO</b><br/>
{conclusion}<br/><br/>

<b>Puntuaci√≥n General del Cultivo: {promedio_general:.1f}/10</b><br/><br/>

<b>üå± Estado de Salud Vegetal (NDVI):</b> {analisis['ndvi']['estado']['etiqueta']} 
({analisis['ndvi']['estadisticas']['promedio']:.3f}) - Puntuaci√≥n: <font color="{'green' if ndvi_punt >= 7 else 'orange' if ndvi_punt >= 5 else 'red'}">
{ndvi_punt}/10</font><br/>

<b>üíß Estado H√≠drico (NDMI):</b> {analisis['ndmi']['estado']['etiqueta']} 
({analisis['ndmi']['estadisticas']['promedio']:.3f}) - Puntuaci√≥n: <font color="{'green' if ndmi_punt >= 7 else 'orange' if ndmi_punt >= 5 else 'red'}">
{ndmi_punt}/10</font><br/><br/>

{f'<b>üå°Ô∏è CONDICIONES CLIM√ÅTICAS DEL PER√çODO</b><br/>‚Ä¢ Temperatura promedio: <b>{temp_prom_periodo:.1f}¬∞C</b><br/>‚Ä¢ Precipitaci√≥n acumulada: <b>{precip_total_periodo:.1f} mm</b><br/><br/>' if temp_prom_periodo or precip_total_periodo else ''}

<b>üìà Tendencia General:</b> {analisis['tendencias'].get('tendencia_lineal', {}).get('direccion', 'estable').title()} 
({analisis['tendencias'].get('tendencia_lineal', {}).get('cambio_porcentual', 0):+.1f}%)<br/><br/>

{'<b><font color="red">‚ö†Ô∏è ALERTAS:</font></b> ' + str(len(alertas_criticas)) + ' situaciones cr√≠ticas requieren atenci√≥n inmediata.' if tiene_alertas else '<font color="green">‚úÖ No se detectaron situaciones cr√≠ticas.</font>'}
"""
            
            resumen = Paragraph(resumen_texto, self.estilos['TextoNormal'])
            elements.append(resumen)
        
        return elements
    
    def _crear_info_parcela(self, parcela: Parcela) -> List:
        """Crea secci√≥n de informaci√≥n de la parcela"""
        elements = []
        
        titulo = Paragraph("üìç Informaci√≥n de la Parcela", self.estilos['TituloSeccion'])
        elements.append(titulo)
        
        # Coordenadas del centroide
        if parcela.centroide:
            lat = parcela.centroide.y
            lon = parcela.centroide.x
            coordenadas = f"{lat:.6f}, {lon:.6f}"
        else:
            coordenadas = "No disponible"
        
        info_texto = f"""
<strong>Nombre:</strong> {parcela.nombre}<br/>
<strong>Propietario:</strong> {parcela.propietario}<br/>
<strong>Tipo de Cultivo:</strong> {parcela.tipo_cultivo or 'No especificado'}<br/>
<strong>√Årea:</strong> {parcela.area_hectareas:.2f} hect√°reas<br/>
<strong>Ubicaci√≥n (Centro):</strong> {coordenadas}<br/>
<strong>Fecha de Inicio de Monitoreo:</strong> {parcela.fecha_inicio_monitoreo.strftime('%d/%m/%Y') if parcela.fecha_inicio_monitoreo else 'No especificado'}<br/>
"""
        
        info = Paragraph(info_texto, self.estilos['TextoNormal'])
        elements.append(info)
        
        return elements
    
    def _crear_seccion_ndvi(self, analisis: Dict, graficos: Dict) -> List:
        """Crea secci√≥n de an√°lisis NDVI - Resumen del per√≠odo completo"""
        elements = []
        
        titulo = Paragraph("üå± An√°lisis NDVI - Vigor Vegetal (Todo el Per√≠odo)", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Resumen del per√≠odo
        estado = analisis['estado']
        ndvi_promedio = analisis['estadisticas']['promedio']
        ndvi_min = analisis['estadisticas'].get('minimo', 0)
        ndvi_max = analisis['estadisticas'].get('maximo', 1)
        
        estado_texto = f"""
<strong>Estado Promedio:</strong> {estado['icono']} {estado['etiqueta']}<br/>
<strong>NDVI Promedio del Per√≠odo:</strong> {ndvi_promedio:.3f}<br/>
<strong>Rango Observado:</strong> {ndvi_min:.3f} - {ndvi_max:.3f}<br/>
<strong>Puntuaci√≥n:</strong> {analisis['puntuacion']}/10<br/>
"""
        elements.append(Paragraph(estado_texto, self.estilos['TextoNormal']))
        elements.append(Spacer(1, 0.5*cm))
        
        # ¬øQu√© mide NDVI?
        que_es = Paragraph(
            "<strong>¬øQu√© mide el NDVI?</strong> El NDVI (Normalized Difference Vegetation Index) mide el <b>vigor vegetal</b> "
            "y la cantidad de biomasa verde activa. Valores >0.7 indican vegetaci√≥n densa y saludable, "
            "valores <0.4 sugieren estr√©s o baja cobertura.",
            self.estilos['TextoNormal']
        )
        elements.append(que_es)
        elements.append(Spacer(1, 0.5*cm))
        
        # Interpretaci√≥n t√©cnica del per√≠odo completo - LIMPIADO
        interpretacion_limpia = limpiar_html_completo(analisis['interpretacion_tecnica'])
        elements.append(Paragraph(interpretacion_limpia, self.estilos['AnalisisTecnico']))
        
        return elements
    
    def _crear_seccion_ndmi(self, analisis: Dict, graficos: Dict) -> List:
        """Crea secci√≥n de an√°lisis NDMI - Resumen del per√≠odo completo"""
        elements = []
        
        titulo = Paragraph("üíß An√°lisis NDMI - Contenido de Humedad (Todo el Per√≠odo)", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Resumen del per√≠odo
        estado = analisis['estado']
        ndmi_promedio = analisis['estadisticas']['promedio']
        ndmi_min = analisis['estadisticas'].get('minimo', -1)
        ndmi_max = analisis['estadisticas'].get('maximo', 1)
        
        estado_texto = f"""
<strong>Estado H√≠drico Promedio:</strong> {estado['icono']} {estado['etiqueta']}<br/>
<strong>NDMI Promedio del Per√≠odo:</strong> {ndmi_promedio:.3f}<br/>
<strong>Rango Observado:</strong> {ndmi_min:.3f} - {ndmi_max:.3f}<br/>
<strong>Puntuaci√≥n:</strong> {analisis['puntuacion']}/10<br/>
"""
        elements.append(Paragraph(estado_texto, self.estilos['TextoNormal']))
        elements.append(Spacer(1, 0.5*cm))
        
        # ¬øQu√© mide NDMI?
        que_es = Paragraph(
            "<strong>¬øQu√© mide el NDMI?</strong> El NDMI (Normalized Difference Moisture Index) mide el <b>contenido de humedad</b> "
            "en la vegetaci√≥n. Valores positivos (>0.2) indican buena hidrataci√≥n, "
            "valores negativos sugieren estr√©s h√≠drico.",
            self.estilos['TextoNormal']
        )
        elements.append(que_es)
        elements.append(Spacer(1, 0.5*cm))
        
        # Interpretaci√≥n t√©cnica del per√≠odo completo - LIMPIADO
        interpretacion_limpia = limpiar_html_completo(analisis['interpretacion_tecnica'])
        elements.append(Paragraph(interpretacion_limpia, self.estilos['TextoNormal']))
        
        return elements
    
    def _crear_seccion_savi(self, analisis: Dict, graficos: Dict) -> List:
        """Crea secci√≥n de an√°lisis SAVI - Resumen del per√≠odo completo"""
        elements = []
        
        titulo = Paragraph("üåæ An√°lisis SAVI - Cobertura Vegetal (Todo el Per√≠odo)", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Resumen del per√≠odo
        estado = analisis['estado']
        savi_promedio = analisis['estadisticas']['promedio']
        savi_min = analisis['estadisticas'].get('minimo', 0)
        savi_max = analisis['estadisticas'].get('maximo', 1)
        
        estado_texto = f"""
<strong>Cobertura Promedio:</strong> {estado['icono']} {estado['etiqueta']}<br/>
<strong>SAVI Promedio del Per√≠odo:</strong> {savi_promedio:.3f}<br/>
<strong>Rango Observado:</strong> {savi_min:.3f} - {savi_max:.3f}<br/>
"""
        elements.append(Paragraph(estado_texto, self.estilos['TextoNormal']))
        elements.append(Spacer(1, 0.5*cm))
        
        # ¬øQu√© mide SAVI? - Aclaraci√≥n importante
        que_es = Paragraph(
            "<strong>¬øQu√© mide el SAVI?</strong> El SAVI (Soil-Adjusted Vegetation Index) mide la <b>cobertura vegetal real</b>, "
            "corrigiendo la influencia del suelo expuesto. <em>SAVI es el √≠ndice de cobertura, no NDVI.</em> "
            "Es especialmente √∫til en cultivos dispersos o en fases tempranas de desarrollo.",
            self.estilos['TextoNormal']
        )
        elements.append(que_es)
        elements.append(Spacer(1, 0.5*cm))
        
        # Interpretaci√≥n t√©cnica del per√≠odo completo - LIMPIADO
        interpretacion_limpia = limpiar_html_completo(analisis['interpretacion_tecnica'])
        elements.append(Paragraph(interpretacion_limpia, self.estilos['AnalisisTecnico']))
        
        return elements
    
    def _crear_seccion_tendencias(self, tendencias: Dict, graficos: Dict) -> List:
        """Crea secci√≥n de an√°lisis de tendencias"""
        elements = []
        
        titulo = Paragraph("üìà An√°lisis de Tendencias Temporales", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Gr√°fico de evoluci√≥n
        if 'evolucion_temporal' in graficos:
            img = Image(graficos['evolucion_temporal'], width=16*cm, height=8*cm)
            elements.append(img)
            elements.append(Spacer(1, 0.3*cm))
            pie = Paragraph(
                "<strong>Figura 1:</strong> Evoluci√≥n temporal de √≠ndices de vegetaci√≥n durante el per√≠odo analizado.",
                self.estilos['PieImagen']
            )
            elements.append(pie)
            elements.append(Spacer(1, 1*cm))
            tendencia_texto = f"""
<strong>Tendencia Lineal:</strong> {tl.get('direccion', '').title()} - 
Fuerza {tl.get('fuerza', '').title()}<br/>
<strong>Cambio Total:</strong> {tl.get('cambio_porcentual', 0):+.1f}%<br/>
<strong>Confiabilidad:</strong> {tl.get('confianza', '').title()} (R¬≤ = {tl.get('r_cuadrado', 0):.3f})<br/>
"""
            elements.append(Spacer(1, 0.5*cm))
            elements.append(Paragraph(tendencia_texto, self.estilos['TextoNormal']))
        
        # Gr√°fico comparativo
        if 'comparativo' in graficos:
            elements.append(Spacer(1, 1*cm))
            img = Image(graficos['comparativo'], width=14*cm, height=8*cm)
            elements.append(img)
            elements.append(Spacer(1, 0.3*cm))
            pie = Paragraph(
                "<strong>Figura 2:</strong> Comparaci√≥n de promedios de √≠ndices durante el per√≠odo.",
                self.estilos['PieImagen']
            )
            elements.append(pie)
        
        return elements
    
    def _crear_seccion_recomendaciones(self, recomendaciones: List[Dict]) -> List:
        """Crea secci√≥n de recomendaciones"""
        elements = []
        
        titulo = Paragraph("üí° Recomendaciones Agron√≥micas", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        intro = Paragraph(
            "A continuaci√≥n se presentan las recomendaciones priorizadas para el manejo del cultivo, "
            "ordenadas por nivel de prioridad (Alta, Media, Baja).",
            self.estilos['TextoNormal']
        )
        elements.append(intro)
        elements.append(Spacer(1, 0.5*cm))
        
        # Agrupar por prioridad
        por_prioridad = {'alta': [], 'media': [], 'baja': []}
        for rec in recomendaciones:
            prioridad = rec.get('prioridad', 'baja')
            por_prioridad[prioridad].append(rec)

        # Renderizar por prioridad
        contador = 1
        for prioridad in ['alta', 'media', 'baja']:
            if por_prioridad[prioridad]:
                # T√≠tulo de prioridad
                if prioridad == 'alta':
                    titulo_prioridad = "üî¥ Prioridad Alta"
                elif prioridad == 'media':
                    titulo_prioridad = "üü° Prioridad Media"
                else:
                    titulo_prioridad = "üü¢ Prioridad Baja"

                elements.append(Paragraph(f"<b>{titulo_prioridad}</b>", self.estilos['TextoNormal']))
                elements.append(Spacer(1, 0.3*cm))

                for rec in por_prioridad[prioridad]:
                    # Limpiar y justificar cada campo
                    titulo = limpiar_html_completo(f"<b>{contador}. {rec['titulo']}</b>")
                    desc_tecnica = limpiar_html_completo(f"<b>Para t√©cnicos:</b> {rec['descripcion_tecnica']}")
                    desc_simple = limpiar_html_completo(f"<b>En palabras simples:</b> {rec['descripcion_simple']}")
                    acciones = [limpiar_html_completo(f"‚Ä¢ {a}") for a in rec['acciones'][:5]]
                    impacto = limpiar_html_completo(f"<b>Impacto esperado:</b> {rec['impacto_esperado']}")
                    tiempo = limpiar_html_completo(f"<b>Tiempo de implementaci√≥n:</b> {rec['tiempo_implementacion']}")

                    rec_data = [
                        [Paragraph(titulo, self.estilos['AnalisisTecnico'])],
                        [Paragraph(desc_tecnica, self.estilos['AnalisisTecnico'])],
                        [Paragraph(desc_simple, self.estilos['AnalisisTecnico'])],
                        [Paragraph("<b>Acciones sugeridas:</b>", self.estilos['AnalisisTecnico'])]
                    ]
                    for accion in acciones:
                        rec_data.append([Paragraph(accion, self.estilos['AnalisisTecnico'])])
                    rec_data.append([Paragraph(impacto, self.estilos['AnalisisTecnico'])])
                    rec_data.append([Paragraph(tiempo, self.estilos['AnalisisTecnico'])])

                    tabla_rec = Table(rec_data, colWidths=[16*cm])
                    tabla_rec.setStyle(TableStyle([
                        ('FONTNAME', (0, 0), (-1, -1), 'Helvetica'),
                        ('FONTSIZE', (0, 0), (-1, -1), 10),
                        ('TEXTCOLOR', (0, 0), (-1, -1), self.colores['gris_oscuro']),
                        ('BACKGROUND', (0, 0), (-1, 0), self.colores['gris_claro']),
                        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                        ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                        ('TOPPADDING', (0, 0), (-1, -1), 8),
                        ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
                        ('LEFTPADDING', (0, 0), (-1, -1), 10),
                        ('BOX', (0, 0), (-1, -1), 1, colors.grey),
                    ]))
                    elements.append(tabla_rec)
                    elements.append(Spacer(1, 0.5*cm))
                    contador += 1
        return elements
    
    def _crear_seccion_analisis_gemini(self, analisis_gemini: Dict) -> List:
        """
        Crea secci√≥n con an√°lisis detallado de Gemini AI
        Incluye: An√°lisis de Tendencias, Recomendaciones IA y Alertas
        """
        elements = []
        
        # T√≠tulo principal de la secci√≥n
        titulo = Paragraph(
            "ü§ñ An√°lisis Inteligente con IA", 
            self.estilos['TituloSeccion']
        )
        elements.append(titulo)
        elements.append(Spacer(1, 0.3*cm))
        # Badge informativo
        badge = Paragraph(
            '<para alignment="center"><font color="#17a2b8" size="9">'
            '<i>Los siguientes an√°lisis han sido generados por inteligencia artificial '
            'especializada en agronom√≠a y teledetecci√≥n satelital.</i></font></para>',
            self.estilos['TextoNormal']
        )
        elements.append(badge)
        elements.append(Spacer(1, 0.7*cm))
        
        # === AN√ÅLISIS DE TENDENCIAS ===
        if analisis_gemini.get('analisis_tendencias'):
            subtitulo = Paragraph("üìà An√°lisis de Tendencias", self.estilos['SubtituloSeccion'])
            elements.append(subtitulo)
            elements.append(Spacer(1, 0.3*cm))
            
            tendencias_texto = limpiar_html_completo(analisis_gemini['analisis_tendencias'])
            
            tendencias = Paragraph(tendencias_texto, self.estilos['TextoNormal'])
            elements.append(tendencias)
            elements.append(Spacer(1, 0.7*cm))
        
        # === AN√ÅLISIS VISUAL DE IM√ÅGENES SATELITALES ===
        if analisis_gemini.get('analisis_visual'):
            analisis_visual_texto = analisis_gemini['analisis_visual'].strip()
            
            # Solo mostrar si hay an√°lisis visual real (no el mensaje por defecto)
            if analisis_visual_texto and 'no disponible' not in analisis_visual_texto.lower():
                subtitulo = Paragraph("üõ∞Ô∏è An√°lisis Visual de Im√°genes Satelitales", self.estilos['SubtituloSeccion'])
                elements.append(subtitulo)
                elements.append(Spacer(1, 0.3*cm))
                
                analisis_visual_texto = limpiar_html_completo(analisis_visual_texto)
                
                analisis_visual = Paragraph(analisis_visual_texto, self.estilos['TextoNormal'])
                
                # Tabla con fondo verde claro para an√°lisis visual
                tabla_visual = Table([[analisis_visual]], colWidths=[16*cm])
                tabla_visual.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f0fff4')),
                    ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#4CAF50')),
                    ('TOPPADDING', (0, 0), (-1, -1), 12),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
                    ('LEFTPADDING', (0, 0), (-1, -1), 12),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 12),
                ]))
                
                elements.append(tabla_visual)
                elements.append(Spacer(1, 0.7*cm))
        
        # === RECOMENDACIONES IA ===
        if analisis_gemini.get('recomendaciones'):
            subtitulo = Paragraph("üí° Recomendaciones del Experto IA", self.estilos['SubtituloSeccion'])
            elements.append(subtitulo)
            elements.append(Spacer(1, 0.3*cm))
            
            recomendaciones_texto = limpiar_html_completo(analisis_gemini['recomendaciones'])
            
            # Crear caja destacada para recomendaciones
            recomendaciones = Paragraph(recomendaciones_texto, self.estilos['TextoNormal'])
            
            # Tabla para dar formato de caja
            tabla_rec = Table([[recomendaciones]], colWidths=[16*cm])
            tabla_rec.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f0f8ff')),
                ('BOX', (0, 0), (-1, -1), 2, self.colores['azul']),
                ('TOPPADDING', (0, 0), (-1, -1), 12),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
                ('LEFTPADDING', (0, 0), (-1, -1), 12),
                ('RIGHTPADDING', (0, 0), (-1, -1), 12),
            ]))
            
            elements.append(tabla_rec)
            elements.append(Spacer(1, 0.7*cm))
        
        # === ALERTAS ===
        if analisis_gemini.get('alertas'):
            alertas_texto = analisis_gemini['alertas'].strip()
            
            # Solo mostrar si hay alertas reales (no el mensaje por defecto)
            if alertas_texto and 'No se detectaron alertas' not in alertas_texto:
                subtitulo = Paragraph("‚ö†Ô∏è Alertas y Situaciones Cr√≠ticas", self.estilos['SubtituloSeccion'])
                elements.append(subtitulo)
                elements.append(Spacer(1, 0.3*cm))
                
                alertas_texto = alertas_texto.replace('\n\n', '<br/><br/>')
                alertas_texto = alertas_texto.replace('\n', '<br/>')
                alertas_texto = limpiar_html_completo(alertas_texto)
                
                alertas = Paragraph(alertas_texto, self.estilos['TextoNormal'])
                
                # Tabla con fondo rojo claro para alertas
                tabla_alertas = Table([[alertas]], colWidths=[16*cm])
                tabla_alertas.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#fff5f5')),
                    ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#ff4444')),
                    ('TOPPADDING', (0, 0), (-1, -1), 12),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
                    ('LEFTPADDING', (0, 0), (-1, -1), 12),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 12),
                ]))
                
                elements.append(tabla_alertas)
                elements.append(Spacer(1, 0.5*cm))
            else:
                # Mensaje positivo si no hay alertas
                sin_alertas = Paragraph(
                    '<para alignment="center"><font color="green" size="10">'
                    '<b>‚úÖ No se detectaron situaciones cr√≠ticas que requieran atenci√≥n inmediata.</b>'
                    '</font></para>',
                    self.estilos['TextoNormal']
                )
                elements.append(sin_alertas)
                elements.append(Spacer(1, 0.5*cm))
        
        # Nota al pie de la secci√≥n
        nota = Paragraph(
            '<para alignment="right"><font size="8" color="#666666">'
            '<i>An√°lisis generado por IA avanzada.</i>'
            '</font></para>',
            self.estilos['TextoNormal']
        )
        elements.append(nota)
        
        return elements
    
    def _evaluar_calidad_imagen(self, tipo_indice: str, valor_promedio: float, 
                                valor_minimo: float, valor_maximo: float) -> Dict:
        """Eval√∫a cualitativamente la calidad de una imagen satelital"""
        
        # Calcular heterogeneidad espacial
        rango = valor_maximo - valor_minimo if valor_maximo and valor_minimo else 0
        es_heterogeneo = rango > 0.2
        
        if tipo_indice == 'NDVI':
            if valor_promedio >= 0.7:
                return {'etiqueta': 'Excelente', 'icono': 'üü¢', 'color': '#4CAF50'}
            elif valor_promedio >= 0.5:
                return {'etiqueta': 'Bueno', 'icono': 'üü¢', 'color': '#8BC34A'}
            elif valor_promedio >= 0.3:
                return {'etiqueta': 'Regular', 'icono': 'üü°', 'color': '#FFC107'}
            else:
                return {'etiqueta': 'Pobre', 'icono': 'üî¥', 'color': '#F44336'}
        
        elif tipo_indice == 'NDMI':
            if valor_promedio >= 0.2:
                return {'etiqueta': 'Excelente', 'icono': 'üíß', 'color': '#2196F3'}
            elif valor_promedio >= 0.0:
                return {'etiqueta': 'Bueno', 'icono': 'üíß', 'color': '#03A9F4'}
            elif valor_promedio >= -0.2:
                return {'etiqueta': 'Regular', 'icono': '‚ö†Ô∏è', 'color': '#FFC107'}
            else:
                return {'etiqueta': 'Bajo', 'icono': 'üî¥', 'color': '#F44336'}
        
        elif tipo_indice == 'SAVI':
            if valor_promedio >= 0.5:
                return {'etiqueta': 'Excelente', 'icono': 'üåæ', 'color': '#4CAF50'}
            elif valor_promedio >= 0.3:
                return {'etiqueta': 'Bueno', 'icono': 'üåæ', 'color': '#8BC34A'}
            else:
                return {'etiqueta': 'Bajo', 'icono': '‚ö†Ô∏è', 'color': '#FFC107'}
        
        return {'etiqueta': 'N/D', 'icono': '‚ùì', 'color': '#999999'}
    
    def _crear_analisis_integrado_mes(self, indice: IndiceMensual, imagenes_mes: List[Dict], parcela: Parcela) -> List:
        """
        Crea an√°lisis integrado inteligente relacionando las 3 im√°genes satelitales del mes
        Usa los motores de an√°lisis especializados (NDVI, NDMI, SAVI) para generar insights cruzados
        """
        elements = []
        
        try:
            # Contexto temporal del an√°lisis
            periodo = indice.periodo_texto
            
            # Extraer valores de las 3 im√°genes
            valores_indices = {}
            for img in imagenes_mes:
                valores_indices[img['tipo']] = {
                    'promedio': img['promedio'],
                    'minimo': img['minimo'],
                    'maximo': img['maximo']
        An√°lisis integrado HIST√ìRICO de las 3 im√°genes satelitales del mes (NDVI, NDMI, SAVI)
        Describe lo que sucedi√≥ en ese per√≠odo espec√≠fico usando tiempo pasado
        """
        elements = []
        
        try:
            periodo = indice.periodo_texto
            
            # Extraer valores de las 3 im√°genes
            vals = {}
            for img in imagenes_mes:
                vals[img['tipo']] = {
                    'prom': img['promedio'],
                    'min': img['minimo'],
                    'max': img['maximo']
                }
            
            analisis = []
            analisis.append(f"<b>üìä An√°lisis Integrado de {periodo}</b><br/><br/>")
            
            # === 1. VALORES REGISTRADOS DE LAS 3 IM√ÅGENES ===
            analisis.append("<b>Valores de los √çndices Satelitales:</b><br/>")
            if 'NDVI' in vals:
                analisis.append(f"‚Ä¢ <b>NDVI</b> (vigor vegetal): {vals['NDVI']['prom']:.3f}<br/>")
            if 'NDMI' in vals:
                analisis.append(f"‚Ä¢ <b>NDMI</b> (contenido de humedad): {vals['NDMI']['prom']:.3f}<br/>")
            if 'SAVI' in vals:
                analisis.append(f"‚Ä¢ <b>SAVI</b> (cobertura vegetal): {vals['SAVI']['prom']:.3f}<br/><br/>")
            
            # === 2. AN√ÅLISIS INTEGRADO NDVI + NDMI (Vigor + Humedad) ===
            if 'NDVI' in vals and 'NDMI' in vals:
                ndvi = vals['NDVI']['prom']
                ndmi = vals['NDMI']['prom']
                
                analisis.append(f"<b>üîç Condici√≥n del Cultivo en {periodo}:</b> ")
                
                if ndvi > 0.6 and ndmi > 0.1:
                    analisis.append(
                        f"El cultivo present√≥ <b>excelentes condiciones</b> con alto vigor vegetal (NDVI={ndvi:.3f}) "
                        f"y buena hidrataci√≥n (NDMI={ndmi:.3f}). Esto indic√≥ crecimiento saludable con acceso "
                        f"adecuado al agua durante este mes."
                    )
                elif ndvi > 0.6 and ndmi < 0:
                    analisis.append(
                        f"‚ö†Ô∏è Se detect√≥ <b>estr√©s h√≠drico</b>: a pesar del buen vigor (NDVI={ndvi:.3f}), "
                        f"el contenido de humedad fue bajo (NDMI={ndmi:.3f}). El cultivo pudo haber estado "
                        f"limitado por falta de agua en este per√≠odo."
                    )
                elif ndvi < 0.4 and ndmi > 0.1:
                    analisis.append(
                        f"Se observ√≥ bajo vigor (NDVI={ndvi:.3f}) con alta humedad (NDMI={ndmi:.3f}), "
                        f"lo que pudo indicar saturaci√≥n de suelo o problemas de drenaje que afectaron el desarrollo."
                    )
                elif ndvi < 0.4 and ndmi < 0:
                    analisis.append(
                        f"üî¥ Se registr√≥ <b>estr√©s cr√≠tico</b>: tanto vigor (NDVI={ndvi:.3f}) como humedad "
                        f"(NDMI={ndmi:.3f}) estuvieron en niveles bajos, indicando condiciones severas que "
                        f"requirieron atenci√≥n inmediata."
                    )
                else:
                    analisis.append(
                        f"Los √≠ndices estuvieron en rangos moderados (NDVI={ndvi:.3f}, NDMI={ndmi:.3f}), "
                        f"representando un desarrollo estable durante {periodo}."
                    )
                analisis.append("<br/><br/>")
            
            # === 3. AN√ÅLISIS DE COBERTURA (SAVI vs NDVI) ===
            if 'SAVI' in vals and 'NDVI' in vals:
                savi = vals['SAVI']['prom']
                ndvi = vals['NDVI']['prom']
                dif = abs(ndvi - savi)
                
                analisis.append("<b>üåæ An√°lisis de Cobertura Vegetal:</b> ")
                if dif > 0.15:
                    cobertura_pct = int(savi * 100)
                    analisis.append(
                        f"El SAVI ({savi:.3f}) fue significativamente menor que el NDVI ({ndvi:.3f}), "
                        f"lo que revel√≥ que el suelo expuesto influy√≥ en las mediciones durante {periodo}. "
                        f"La cobertura vegetal real fue aproximadamente {cobertura_pct}%, sugiriendo "
                        f"vegetaci√≥n dispersa o suelo desnudo entre plantas."
                    )
                else:
                    cobertura_pct = int(savi * 100)
                    analisis.append(
                        f"El SAVI ({savi:.3f}) y NDVI ({ndvi:.3f}) fueron similares, indicando "
                        f"aproximadamente {cobertura_pct}% de cobertura con buen desarrollo del dosel "
                        f"y m√≠nima exposici√≥n de suelo."
                    )
                analisis.append("<br/><br/>")
            
            # === 4. VARIABILIDAD ESPACIAL DEL MES ===
            max_var = 0
            idx_var = None
            for tipo, v in vals.items():
                var = v['max'] - v['min']
                if var > max_var:
                    max_var = var
                    idx_var = tipo
            
            if idx_var:
                analisis.append(
                    f"<b>üó∫Ô∏è Heterogeneidad Detectada en {periodo}:</b> "
                    f"El √≠ndice {idx_var} mostr√≥ un rango de {vals[idx_var]['min']:.3f} a {vals[idx_var]['max']:.3f} "
                    f"dentro del lote (variaci√≥n={max_var:.3f}). "
                )
                if max_var > 0.3:
                    analisis.append(
                        "Esta alta variabilidad evidenci√≥ zonas con condiciones muy diferentes, "
                        "posiblemente por desarrollo desigual o variabilidad del suelo."
                    )
                elif max_var > 0.15:
                    analisis.append(
                        "Esta variabilidad moderada fue t√≠pica de cultivos en diferentes fases fenol√≥gicas."
                    )
                else:
                    analisis.append(
                        "Esta baja variabilidad indic√≥ condiciones homog√©neas en todo el lote."
                    )
            
            # Crear caja visual con el an√°lisis
            if analisis:
                texto_completo = Paragraph(
                    f'<para alignment="justify" backColor="#F8F9FA" '
                    f'leftIndent="10" rightIndent="10" spaceBefore="10" spaceAfter="10">'
                    f'<font size="9">{"".join(analisis)}</font>'
                    f'</para>',
                    self.estilos['TextoNormal']
                )
                
                titulo_analisis = Paragraph(
                    '<para alignment="center" backColor="#2E7D32" '
                    'leftIndent="5" rightIndent="5" spaceBefore="5" spaceAfter="5">'
                    '<font size="10" color="white"><b>üìä AN√ÅLISIS HIST√ìRICO DEL MES</b></font>'
                    '</para>',
                    self.estilos['TituloSeccion']
                )
                
                # Tabla contenedora
                tabla_analisis = Table(
                    [[titulo_analisis], [texto_completo]], 
                    colWidths=[15*cm]
                )
                tabla_analisis.setStyle(TableStyle([
                    ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#2E7D32')),
                    ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ('TOPPADDING', (0, 0), (-1, -1), 0),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 0),
                    ('LEFTPADDING', (0, 0), (-1, -1), 0),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 0),
                ]))
                
                elements.append(tabla_analisis)
                
        except Exception as e:
            logger.warning(f"Error generando an√°lisis integrado del mes: {e}")
        
        return elements
    
    def _crear_galeria_imagenes_satelitales(self, parcela: Parcela, indices: List[IndiceMensual]) -> List:
        """
        Crea una galer√≠a de im√°genes satelitales (NDVI, NDMI, SAVI) mes a mes
        con an√°lisis visual espec√≠fico por imagen generado por Gemini AI
        """
        elements = []
        # Decoraci√≥n superior (6.png)
        elements.extend(self._decorar_seccion('6.png', height=1*cm))
        # T√≠tulo de la secci√≥n con dise√±o mejorado
        titulo = Paragraph(
            'üì∏ <font size="16"><strong>Im√°genes Satelitales y An√°lisis Visual Detallado</strong></font>',
            self.estilos['TituloSeccion']
        )
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Introducci√≥n mejorada con explicaci√≥n de colores
        intro = Paragraph(
            """
            <strong>Esta secci√≥n presenta un an√°lisis visual detallado de las im√°genes satelitales capturadas mes a mes.</strong>
            <br/><br/>
            Cada imagen es analizada por inteligencia artificial para identificar patrones espaciales, zonas espec√≠ficas 
            y cambios temporales. Los colores en las im√°genes representan:
            <br/><br/>
            ‚Ä¢ <strong>NDVI (Vigor Vegetal):</strong> Verde oscuro = alta biomasa, amarillo/marr√≥n = baja vegetaci√≥n<br/>
            ‚Ä¢ <strong>NDMI (Contenido de Humedad):</strong> Azul/verde = alta humedad, rojo/amarillo = baja humedad<br/>
            ‚Ä¢ <strong>SAVI (Cobertura del Suelo):</strong> Verde = buena cobertura, marr√≥n = suelo desnudo visible
            """,
            self.estilos['TextoNormal']
        )
        
        # Crear caja destacada para la introducci√≥n
        tabla_intro = Table([[intro]], colWidths=[15*cm])
        tabla_intro.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#e8f5e9')),
            ('BOX', (0, 0), (-1, -1), 2, self.colores['verde_principal']),
            ('TOPPADDING', (0, 0), (-1, -1), 12),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 12),
            ('LEFTPADDING', (0, 0), (-1, -1), 15),
            ('RIGHTPADDING', (0, 0), (-1, -1), 15),
        ]))
        
        elements.append(tabla_intro)
        elements.append(Spacer(1, 0.7*cm))
        
        # Procesar cada √≠ndice mensual
        imagenes_encontradas = 0
        meses_procesados = 0
        
        for idx in indices:
            tiene_imagenes = False
            
            # Verificar si hay im√°genes para este mes usando la funci√≥n de correcci√≥n de paths
            path_ndvi = self._obtener_path_imagen_correcto(idx.imagen_ndvi)
            path_ndmi = self._obtener_path_imagen_correcto(idx.imagen_ndmi)
            path_savi = self._obtener_path_imagen_correcto(idx.imagen_savi)
            
            if path_ndvi or path_ndmi or path_savi:
                tiene_imagenes = True
            
            # Si hay im√°genes para este mes, procesarlas
            if tiene_imagenes:
                meses_procesados += 1
                
                # === SEPARADOR VISUAL ENTRE MESES ===
                if meses_procesados > 1:
                    from reportlab.platypus import HRFlowable
                    elements.append(Spacer(1, 0.3*cm))
                    elements.append(HRFlowable(
                        width="100%", 
                        thickness=2, 
                        color=self.colores['verde_principal'],
                        spaceAfter=0.5*cm,
                        spaceBefore=0.3*cm
                    ))
                
                # === T√çTULO DEL MES CON DISE√ëO DESTACADO ===
                titulo_mes = Paragraph(
                    f'<font size="13" color="#2E8B57"><strong>üìÖ {idx.periodo_texto}</strong></font>',
                    self.estilos['SubtituloSeccion']
                )
                elements.append(titulo_mes)
                elements.append(Spacer(1, 0.2*cm))
                
                # === METADATOS DE LA CAPTURA EN FORMATO MEJORADO ===
                # Coordenadas del centroide
                coord_texto = 'N/A'
                if parcela.centroide:
                    coord_texto = f"{parcela.centroide.y:.6f}, {parcela.centroide.x:.6f}"
                
                metadatos_data = [
                    ['üìÖ Fecha de captura:', idx.fecha_imagen.strftime('%d/%m/%Y') if idx.fecha_imagen else 'N/A'],
                    ['üõ∞Ô∏è Sat√©lite:', idx.satelite_imagen or 'Sentinel-2'],
                    ['üìè Resoluci√≥n espacial:', f"{idx.resolucion_imagen or 10} metros/p√≠xel"],
                    ['‚òÅÔ∏è Nubosidad:', f"{idx.nubosidad_imagen or 0:.1f}%"],
                    ['üåç Coordenadas:', coord_texto],
                    ['üå°Ô∏è Temperatura promedio:', f"{idx.temperatura_promedio:.1f}¬∞C" if idx.temperatura_promedio else 'N/D'],
                    ['üíß Precipitaci√≥n total:', f"{idx.precipitacion_total:.1f} mm" if idx.precipitacion_total else 'N/D']
                ]
                
                tabla_metadatos = Table(metadatos_data, colWidths=[4*cm, 11*cm])
                tabla_metadatos.setStyle(TableStyle([
                    ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
                    ('FONTNAME', (1, 0), (1, -1), 'Helvetica'),
                    ('FONTSIZE', (0, 0), (-1, -1), 9),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
                    ('TEXTCOLOR', (0, 1), (-1, -1), self.colores['gris_oscuro']),
                    ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                    ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ('ROWBACKGROUNDS', (0, 0), (-1, -1), [colors.white, self.colores['gris_claro']]),
                    ('LINEBELOW', (0, 0), (-1, -2), 0.5, colors.HexColor('#E0E0E0')),
                    ('TOPPADDING', (0, 0), (-1, -1), 8),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
                    ('LEFTPADDING', (0, 0), (-1, -1), 10),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 10),
                ]))
                
                elements.append(tabla_metadatos)
                elements.append(Spacer(1, 0.5*cm))
                
                # === LAYOUT HORIZONTAL: 3 IM√ÅGENES LADO A LADO ===
                # Recolectar las 3 im√°genes disponibles para este mes
                imagenes_mes = []
                
                # NDVI
                if path_ndvi:
                    imagenes_encontradas += 1
                    imagenes_mes.append({
                        'tipo': 'NDVI',
                        'path': path_ndvi,
                        'promedio': idx.ndvi_promedio or 0,
                        'minimo': idx.ndvi_minimo or 0,
                        'maximo': idx.ndvi_maximo or 0,
                        'color_badge': colors.HexColor('#4CAF50'),
                        'descripcion': 'Vigor Vegetal'
                    })
                
                # NDMI
                if path_ndmi:
                    imagenes_encontradas += 1
                    imagenes_mes.append({
                        'tipo': 'NDMI',
                        'path': path_ndmi,
                        'promedio': idx.ndmi_promedio or 0,
                        'minimo': idx.ndmi_minimo or 0,
                        'maximo': idx.ndmi_maximo or 0,
                        'color_badge': colors.HexColor('#2196F3'),
                        'descripcion': 'Humedad'
                    })
                
                # SAVI
                if path_savi:
                    imagenes_encontradas += 1
                    imagenes_mes.append({
                        'tipo': 'SAVI',
                        'path': path_savi,
                        'promedio': idx.savi_promedio or 0,
                        'minimo': idx.savi_minimo or 0,
                        'maximo': idx.savi_maximo or 0,
                        'color_badge': colors.HexColor('#FF9800'),
                        'descripcion': 'Cobertura Suelo'
                    })
                
                # Crear tabla horizontal de 3 columnas
                if imagenes_mes:
                    celdas_imagenes = []
                    
                    for img_data in imagenes_mes:
                        try:
                            # Imagen satelital con tama√±o reducido para evitar superposici√≥n
                            img = Image(img_data['path'], width=4.5*cm, height=4.5*cm, kind='proportional')
                            
                            # Badge de tipo de √≠ndice
                            badge = Paragraph(
                                f'<para align="center" backColor="{img_data["color_badge"]}" '
                                f'leftIndent="2" rightIndent="2" spaceAfter="5">'
                                f'<font size="9" color="white"><strong>{img_data["tipo"]}</strong></font>'
                                f'</para>',
                                self.estilos['TextoNormal']
                            )
                            
                            # Descripci√≥n
                            desc = Paragraph(
                                f'<para align="center"><font size="8" color="#666666">'
                                f'<i>{img_data["descripcion"]}</i></font></para>',
                                self.estilos['TextoNormal']
                            )
                            
                            # Valores estad√≠sticos
                            valores = Paragraph(
                                f'<para align="center"><font size="8">'
                                f'<strong>Prom:</strong> {img_data["promedio"]:.3f}<br/>'
                                f'<font color="#999999">Min: {img_data["minimo"]:.3f} | Max: {img_data["maximo"]:.3f}</font>'
                                f'</font></para>',
                                self.estilos['TextoNormal']
                            )
                            
                            # === AN√ÅLISIS CUALITATIVO ===
                            evaluacion = self._evaluar_calidad_imagen(
                                tipo_indice=img_data['tipo'],
                                valor_promedio=img_data['promedio'],
                                valor_minimo=img_data['minimo'],
                                valor_maximo=img_data['maximo']
                            )
                            
                            badge_calidad = Paragraph(
                                f'<para align="center"><font size="8" color="{evaluacion["color"]}">'
                                f'<b>{evaluacion["icono"]} {evaluacion["etiqueta"]}</b>'
                                f'</font></para>',
                                self.estilos['TextoNormal']
                            )
                            
                            # Apilar verticalmente: badge + imagen + desc + valores + calidad
                            celda_contenido = [[badge], [img], [desc], [Spacer(1, 0.1*cm)], [valores], [badge_calidad]]
                            tabla_celda = Table(celda_contenido, colWidths=[4.8*cm])
                            tabla_celda.setStyle(TableStyle([
                                ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                                ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                                ('LEFTPADDING', (0, 0), (-1, -1), 2),
                                ('RIGHTPADDING', (0, 0), (-1, -1), 2),
                                ('TOPPADDING', (0, 0), (-1, -1), 2),
                                ('BOTTOMPADDING', (0, 0), (-1, -1), 2),
                            ]))
                            
                            celdas_imagenes.append(tabla_celda)
                            
                        except Exception as e:
                            logger.warning(f"Error procesando imagen {img_data['tipo']}: {e}")
                            continue
                    
                    # Crear tabla horizontal de 3 columnas
                    if celdas_imagenes:
                        # Rellenar con celdas vac√≠as si faltan im√°genes
                        while len(celdas_imagenes) < 3:
                            celda_vacia = Paragraph(
                                '<para align="center"><font size="10" color="#CCCCCC">‚îÄ</font></para>',
                                self.estilos['TextoNormal']
                            )
                            celdas_imagenes.append(celda_vacia)
                        
                        tabla_horizontal = Table([celdas_imagenes], colWidths=[5*cm, 5*cm, 5*cm])
                        tabla_horizontal.setStyle(TableStyle([
                            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                            ('BOX', (0, 0), (-1, -1), 1, colors.HexColor('#E0E0E0')),
                            ('INNERGRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#F0F0F0')),
                            ('TOPPADDING', (0, 0), (-1, -1), 10),
                            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
                            ('LEFTPADDING', (0, 0), (-1, -1), 5),
                            ('RIGHTPADDING', (0, 0), (-1, -1), 5),
                        ]))
                        
                        elements.append(tabla_horizontal)
                        elements.append(Spacer(1, 0.5*cm))
                        
                        # ü§ñ AN√ÅLISIS INTELIGENTE DE LAS 3 IM√ÅGENES RELACIONADAS
                        if len(imagenes_mes) >= 2:
                            elements.extend(self._crear_analisis_integrado_mes(idx, imagenes_mes, parcela))
                        
                        elements.append(Spacer(1, 0.5*cm))
                        
                        # An√°lisis Gemini consolidado para el mes (si est√° disponible)
                        if hasattr(idx, 'analisis_gemini') and idx.analisis_gemini:
                            elements.extend(self._crear_analisis_gemini_mes(idx, parcela))
        
        # Si no se encontraron im√°genes
        if imagenes_encontradas == 0:
            sin_imagenes = Paragraph(
                '<para alignment="center"><font color="#999999" size="11">'
                '<br/><br/><br/>'
                '<b>üì≠ No hay im√°genes satelitales disponibles para este per√≠odo</b><br/><br/>'
                '<i>Las im√°genes se descargar√°n autom√°ticamente y estar√°n disponibles en el sistema una vez procesadas.</i>'
                '<br/><br/><br/>'
                '</font></para>',
                self.estilos['TextoNormal']
            )
            tabla_sin_img = Table([[sin_imagenes]], colWidths=[15*cm])
            tabla_sin_img.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#fff3cd')),
                ('BOX', (0, 0), (-1, -1), 2, colors.HexColor('#ffc107')),
                ('TOPPADDING', (0, 0), (-1, -1), 20),
                ('BOTTOMPADDING', (0, 0), (-1, -1), 20),
            ]))
            elements.append(tabla_sin_img)
        else:
            # === AN√ÅLISIS GLOBAL CONSOLIDADO ===
            elements.extend(self._crear_analisis_global_imagenes(parcela, indices, imagenes_encontradas))
            
            # Nota al final con resumen
            nota_final = Paragraph(
                f'<para alignment="right"><font size="9" color="#2E8B57">'
                f'<strong>‚úì Total de im√°genes analizadas: {imagenes_encontradas}</strong> | '
                f'Meses procesados: {meses_procesados}'
                f'</font></para>',
                self.estilos['TextoNormal']
            )
            elements.append(Spacer(1, 0.3*cm))
            elements.append(nota_final)
        
        return elements
    
    def _crear_analisis_global_imagenes(self, parcela: Parcela, indices: List[IndiceMensual], 
                                        total_imagenes: int) -> List:
        """
        Crea la secci√≥n de an√°lisis global consolidado de todas las im√°genes
        """
        elements = []
        
        # Separador visual fuerte
        from reportlab.platypus import HRFlowable
        elements.append(Spacer(1, 0.7*cm))
        elements.append(HRFlowable(
            width="100%", 
            thickness=3, 
            color=self.colores['verde_principal'],
            spaceAfter=0.7*cm,
            spaceBefore=0.3*cm
        ))
        
        # T√≠tulo de la secci√≥n
        titulo_global = Paragraph(
            'üéØ <font size="14"><strong>An√°lisis Global Consolidado del Per√≠odo</strong></font>',
            self.estilos['TituloSeccion']
        )
        elements.append(titulo_global)
        elements.append(Spacer(1, 0.5*cm))
        
        # Subt√≠tulo explicativo
        subtitulo = Paragraph(
            '<font size="10"><i>Evaluaci√≥n integral basada en todas las im√°genes satelitales del per√≠odo, '
            'con identificaci√≥n de patrones espaciales y recomendaciones espec√≠ficas por zona.</i></font>',
            self.estilos['TextoNormal']
        )
        elements.append(subtitulo)
        elements.append(Spacer(1, 0.5*cm))
        
        # Preparar datos para Gemini
        imagenes_datos = []
        
        for idx in indices:
            # NDVI
            path_ndvi = self._obtener_path_imagen_correcto(idx.imagen_ndvi)
            if path_ndvi and idx.ndvi_promedio:
                imagenes_datos.append({
                    'imagen_path': path_ndvi,
                    'tipo_indice': 'NDVI',
                    'valor_promedio': idx.ndvi_promedio,
                    'mes': idx.periodo_texto,
                    'fecha': idx.fecha_imagen.strftime('%d/%m/%Y') if idx.fecha_imagen else 'N/A'
                })
            
            # NDMI
            path_ndmi = self._obtener_path_imagen_correcto(idx.imagen_ndmi)
            if path_ndmi and idx.ndmi_promedio:
                imagenes_datos.append({
                    'imagen_path': path_ndmi,
                    'tipo_indice': 'NDMI',
                    'valor_promedio': idx.ndmi_promedio,
                    'mes': idx.periodo_texto,
                    'fecha': idx.fecha_imagen.strftime('%d/%m/%Y') if idx.fecha_imagen else 'N/A'
                })
            
            # SAVI
            path_savi = self._obtener_path_imagen_correcto(idx.imagen_savi)
            if path_savi and idx.savi_promedio:
                imagenes_datos.append({
                    'imagen_path': path_savi,
                    'tipo_indice': 'SAVI',
                    'valor_promedio': idx.savi_promedio,
                    'mes': idx.periodo_texto,
                    'fecha': idx.fecha_imagen.strftime('%d/%m/%Y') if idx.fecha_imagen else 'N/A'
                })
        
        # Nota: El an√°lisis integrado de im√°genes se realiza mes por mes
        # utilizando los motores especializados de an√°lisis
        
        return elements
    
    
    def _crear_analisis_gemini_mes(self, indice: IndiceMensual, parcela: Parcela) -> List:
        """
        Crea an√°lisis Gemini AI organizado visualmente - REHECHO DESDE CERO
        """
        elements = []
        
        # Verificar si hay an√°lisis Gemini disponible
        if not indice.analisis_gemini or not isinstance(indice.analisis_gemini, dict):
            return elements
        
        analisis_data = indice.analisis_gemini
        
        # T√≠tulo de la secci√≥n
        titulo = Paragraph(
            '<para align="center" spaceBefore="8" spaceAfter="12">'
            '<font size="12" color="#FFFFFF" backColor="#2E7D32">'
            '<b> ü§ñ AN√ÅLISIS INTELIGENTE - IA GEMINI </b>'
            '</font>'
            '</para>',
            self.estilos['SubtituloSeccion']
        )
        tabla_titulo = Table([[titulo]], colWidths=[15.5*cm])
        tabla_titulo.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#2E7D32')),
            ('TOPPADDING', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
        ]))
        elements.append(tabla_titulo)
        elements.append(Spacer(1, 0.4*cm))
        
        # /01 NDVI - Vigor Vegetal
        if analisis_data.get('ndvi'):
            texto_limpio = limpiar_html_completo(analisis_data["ndvi"])
            
            header_ndvi = Paragraph(
                '<para leftIndent="10" spaceBefore="4" spaceAfter="4">'
                '<font size="10" color="white"><b>üå± 01. NDVI - VIGOR VEGETAL</b></font>'
                '</para>',
                self.estilos['TextoNormal']
            )
            
            contenido_ndvi = Paragraph(
                f'<para leftIndent="15" rightIndent="15" spaceBefore="12" spaceAfter="12" leading="16">'
                f'<font size="9.5" color="#2c3e50">{texto_limpio}</font>'
                f'</para>',
                self.estilos['TextoNormal']
            )
            
            tabla_ndvi = Table([[header_ndvi], [contenido_ndvi]], colWidths=[15.5*cm])
            tabla_ndvi.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, 0), colors.HexColor('#4CAF50')),
                ('TOPPADDING', (0, 0), (0, 0), 8),
                ('BOTTOMPADDING', (0, 0), (0, 0), 8),
                ('BACKGROUND', (0, 1), (0, 1), colors.white),
                ('TOPPADDING', (0, 1), (0, 1), 0),
                ('BOTTOMPADDING', (0, 1), (0, 1), 15),
                ('LEFTPADDING', (0, 1), (0, 1), 0),
                ('RIGHTPADDING', (0, 1), (0, 1), 0),
                ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#4CAF50')),
                ('LINEBELOW', (0, 0), (0, 0), 1.5, colors.HexColor('#43A047')),
            ]))
            elements.append(tabla_ndvi)
            elements.append(Spacer(1, 0.4*cm))
        
        # /02 NDMI - Contenido de Humedad
        if analisis_data.get('ndmi'):
            texto_limpio = limpiar_html_completo(analisis_data["ndmi"])
            
            header_ndmi = Paragraph(
                '<para leftIndent="10" spaceBefore="4" spaceAfter="4">'
                '<font size="10" color="white"><b>üíß 02. NDMI - CONTENIDO DE HUMEDAD</b></font>'
                '</para>',
                self.estilos['TextoNormal']
            )
            
            contenido_ndmi = Paragraph(
                f'<para leftIndent="15" rightIndent="15" spaceBefore="12" spaceAfter="12" leading="16">'
                f'<font size="9.5" color="#2c3e50">{texto_limpio}</font>'
                f'</para>',
                self.estilos['TextoNormal']
            )
            
            tabla_ndmi = Table([[header_ndmi], [contenido_ndmi]], colWidths=[15.5*cm])
            tabla_ndmi.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, 0), colors.HexColor('#2196F3')),
                ('TOPPADDING', (0, 0), (0, 0), 8),
                ('BOTTOMPADDING', (0, 0), (0, 0), 8),
                ('BACKGROUND', (0, 1), (0, 1), colors.white),
                ('TOPPADDING', (0, 1), (0, 1), 0),
                ('BOTTOMPADDING', (0, 1), (0, 1), 15),
                ('LEFTPADDING', (0, 1), (0, 1), 0),
                ('RIGHTPADDING', (0, 1), (0, 1), 0),
                ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#2196F3')),
                ('LINEBELOW', (0, 0), (0, 0), 1.5, colors.HexColor('#1E88E5')),
            ]))
            elements.append(tabla_ndmi)
            elements.append(Spacer(1, 0.4*cm))
        
        # /03 SAVI - Cobertura del Suelo
        if analisis_data.get('savi'):
            texto_limpio = limpiar_html_completo(analisis_data["savi"])
            
            header_savi = Paragraph(
                '<para leftIndent="10" spaceBefore="4" spaceAfter="4">'
                '<font size="10" color="white"><b>üåæ 03. SAVI - COBERTURA DEL SUELO</b></font>'
                '</para>',
                self.estilos['TextoNormal']
            )
            
            contenido_savi = Paragraph(
                f'<para leftIndent="15" rightIndent="15" spaceBefore="12" spaceAfter="12" leading="16">'
                f'<font size="9.5" color="#2c3e50">{texto_limpio}</font>'
                f'</para>',
                self.estilos['TextoNormal']
            )
            
            tabla_savi = Table([[header_savi], [contenido_savi]], colWidths=[15.5*cm])
            tabla_savi.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, 0), colors.HexColor('#FF9800')),
                ('TOPPADDING', (0, 0), (0, 0), 8),
                ('BOTTOMPADDING', (0, 0), (0, 0), 8),
                ('BACKGROUND', (0, 1), (0, 1), colors.white),
                ('TOPPADDING', (0, 1), (0, 1), 0),
                ('BOTTOMPADDING', (0, 1), (0, 1), 15),
                ('LEFTPADDING', (0, 1), (0, 1), 0),
                ('RIGHTPADDING', (0, 1), (0, 1), 0),
                ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#FF9800')),
                ('LINEBELOW', (0, 0), (0, 0), 1.5, colors.HexColor('#FB8C00')),
            ]))
            elements.append(tabla_savi)
            elements.append(Spacer(1, 0.4*cm))
        
        # /04 Recomendaciones PRIORITARIAS
        if analisis_data.get('recomendaciones'):
            texto_limpio = limpiar_html_completo(analisis_data['recomendaciones'])
            
            header_recom = Paragraph(
                '<para leftIndent="10" spaceBefore="4" spaceAfter="4">'
                '<font size="10" color="white"><b>‚ö° 04. RECOMENDACIONES PRIORITARIAS</b></font>'
                '</para>',
                self.estilos['TextoNormal']
            )
            
            contenido_recom = Paragraph(
                f'<para leftIndent="15" rightIndent="15" spaceBefore="12" spaceAfter="12" leading="16">'
                f'<font size="9.5" color="#2c3e50"><b>{texto_limpio}</b></font>'
                f'</para>',
                self.estilos['TextoNormal']
            )
            
            tabla_recom = Table([[header_recom], [contenido_recom]], colWidths=[15.5*cm])
            tabla_recom.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (0, 0), colors.HexColor('#FF5722')),
                ('TOPPADDING', (0, 0), (0, 0), 8),
                ('BOTTOMPADDING', (0, 0), (0, 0), 8),
                ('BACKGROUND', (0, 1), (0, 1), colors.HexColor('#FFF8E1')),
                ('TOPPADDING', (0, 1), (0, 1), 0),
                ('BOTTOMPADDING', (0, 1), (0, 1), 15),
                ('LEFTPADDING', (0, 1), (0, 1), 0),
                ('RIGHTPADDING', (0, 1), (0, 1), 0),
                ('BOX', (0, 0), (-1, -1), 2.5, colors.HexColor('#FF5722')),
                ('LINEBELOW', (0, 0), (0, 0), 2, colors.HexColor('#E64A19')),
            ]))
            elements.append(tabla_recom)
            elements.append(Spacer(1, 0.6*cm))
        
        return elements
    
    def _agregar_imagen_con_analisis(self, indice: IndiceMensual, tipo_indice: str, 
                                      imagen_path: str, descripcion: str, usar_gemini: bool = False) -> List:
        """
        Agrega una imagen satelital con su an√°lisis visual espec√≠fico usando Gemini AI
        
        Args:
            indice: IndiceMensual con los datos del mes
            tipo_indice: 'NDVI', 'NDMI', 'SAVI'
            imagen_path: Ruta a la imagen
            descripcion: Descripci√≥n del √≠ndice
            usar_gemini: Si usar Gemini AI para an√°lisis visual (default: False para ahorrar tokens)
        """
        elements = []
        
        try:
            # === IMAGEN ===
            # Cargar y mostrar la imagen m√°s grande para mejor visualizaci√≥n
            img = Image(imagen_path, width=14*cm, height=10*cm)
            img.hAlign = 'CENTER'
            elements.append(img)
            elements.append(Spacer(1, 0.2*cm))
            
            # === T√çTULO Y DESCRIPCI√ìN ===
            titulo_imagen = Paragraph(
                f"<strong>{tipo_indice}</strong> - {descripcion}",
                self.estilos['PieImagen']
            )
            elements.append(titulo_imagen)
            elements.append(Spacer(1, 0.3*cm))
            
            # === VALORES NUM√âRICOS ===
            valor_promedio = None
            valor_minimo = None
            valor_maximo = None
            
            if tipo_indice == 'NDVI':
                valor_promedio = indice.ndvi_promedio
                valor_minimo = indice.ndvi_minimo
                valor_maximo = indice.ndvi_maximo
            elif tipo_indice == 'NDMI':
                valor_promedio = indice.ndmi_promedio
                valor_minimo = indice.ndmi_minimo
                valor_maximo = indice.ndmi_maximo
            elif tipo_indice == 'SAVI':
                valor_promedio = indice.savi_promedio
                valor_minimo = indice.savi_minimo
                valor_maximo = indice.savi_maximo
            
            if valor_promedio is not None:
                min_texto = f"{valor_minimo:.3f}" if valor_minimo is not None else "N/A"
                max_texto = f"{valor_maximo:.3f}" if valor_maximo is not None else "N/A"
                
                valores_texto = f"""
<font size="9" color="#2c3e50">
<strong>Valor promedio:</strong> {valor_promedio:.3f} | 
<strong>M√≠nimo:</strong> {min_texto} | 
<strong>M√°ximo:</strong> {max_texto}
</font>
"""
                valores = Paragraph(valores_texto, self.estilos['TextoNormal'])
                elements.append(valores)
                elements.append(Spacer(1, 0.3*cm))
            
            # === AN√ÅLISIS VISUAL ESPEC√çFICO CON GEMINI AI ===
            if usar_gemini and valor_promedio is not None:
                # Preparar contexto para Gemini
                datos_contexto = {
                    'fecha': indice.fecha_imagen.strftime('%d/%m/%Y') if indice.fecha_imagen else 'N/A',
                    'satelite': indice.satelite_imagen or 'Sentinel-2',
                    'resolucion': indice.resolucion_imagen or 10,
                    'nubosidad': indice.nubosidad_imagen or 0,
                    'coordenadas': f"({indice.parcela.latitud:.6f}, {indice.parcela.longitud:.6f})" if hasattr(indice.parcela, 'latitud') else 'N/A'
                }
                
                # Buscar mes anterior para comparaci√≥n
                mes_anterior_data = self._obtener_datos_mes_anterior(indice, tipo_indice)
                
                # Generar an√°lisis con Gemini
                try:
                    analisis_texto = gemini_service.analizar_imagen_satelital(
                        imagen_path=imagen_path,
                        tipo_indice=tipo_indice,
                        valor_promedio=valor_promedio,
                        datos_contexto=datos_contexto,
                        mes_anterior_data=mes_anterior_data
                    )
                    
                    # Agregar badge indicando que es an√°lisis AI
                    badge_ai = Paragraph(
                        '<font size="7" color="#666666"><strong>ü§ñ An√°lisis generado por Gemini AI</strong></font>',
                        self.estilos['TextoNormal']
                    )
                    elements.append(badge_ai)
                    elements.append(Spacer(1, 0.1*cm))
                    
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è Gemini fall√≥ para {tipo_indice}, usando an√°lisis b√°sico: {str(e)}")
                    analisis_texto = self._generar_analisis_visual_imagen(indice, tipo_indice, valor_promedio)
            else:
                # Usar an√°lisis basado en reglas como fallback
                analisis_texto = self._generar_analisis_visual_imagen(indice, tipo_indice, valor_promedio)
            
            if analisis_texto:
                analisis = Paragraph(analisis_texto, self.estilos['TextoNormal'])
                
                # Caja con an√°lisis visual
                tabla_analisis = Table([[analisis]], colWidths=[15*cm])
                tabla_analisis.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f0f8f0')),  # Verde muy claro
                    ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor('#2E8B57')),  # Borde verde
                    ('TOPPADDING', (0, 0), (-1, -1), 10),
                    ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
                    ('LEFTPADDING', (0, 0), (-1, -1), 12),
                    ('RIGHTPADDING', (0, 0), (-1, -1), 12),
                ]))
                
                elements.append(tabla_analisis)
            
            elements.append(Spacer(1, 0.5*cm))
            
        except Exception as e:
            logger.error(f"‚ùå Error agregando imagen {tipo_indice} de {indice.periodo_texto}: {str(e)}")
            error_msg = Paragraph(
                f'<font color="red">Error cargando imagen {tipo_indice}</font>',
                self.estilos['TextoNormal']
            )
            elements.append(error_msg)
        
        return elements
    
    def _obtener_datos_mes_anterior(self, indice: IndiceMensual, tipo_indice: str) -> Optional[Dict]:
        """
        Obtiene datos del mes anterior para comparaci√≥n temporal
        """
        try:
            if indice.mes == 1:
                mes_anterior = indice.parcela.indices_mensuales.filter(
                    a√±o=indice.a√±o - 1, mes=12
                ).first()
            else:
                mes_anterior = indice.parcela.indices_mensuales.filter(
                    a√±o=indice.a√±o, mes=indice.mes - 1
                ).first()
            
            if mes_anterior:
                valor_anterior = None
                if tipo_indice == 'NDVI':
                    valor_anterior = mes_anterior.ndvi_promedio
                elif tipo_indice == 'NDMI':
                    valor_anterior = mes_anterior.ndmi_promedio
                elif tipo_indice == 'SAVI':
                    valor_anterior = mes_anterior.savi_promedio
                
                if valor_anterior:
                    return {
                        'fecha': mes_anterior.fecha_imagen.strftime('%d/%m/%Y') if mes_anterior.fecha_imagen else 'N/A',
                        'tipo_indice': tipo_indice,
                        'valor': valor_anterior
                    }
        except Exception as e:
            logger.debug(f"No se pudo obtener datos del mes anterior: {str(e)}")
        
        return None
    
    def _generar_analisis_visual_imagen(self, indice: IndiceMensual, tipo_indice: str, 
                                        valor_promedio: float) -> str:
        """
        Genera un an√°lisis visual espec√≠fico basado en los valores del √≠ndice
        y el contexto temporal (comparaci√≥n con mes anterior si est√° disponible)
        """
        if valor_promedio is None:
            return ""
        
        analisis_partes = []
        
        # === INTERPRETACI√ìN DEL VALOR ===
        if tipo_indice == 'NDVI':
            if valor_promedio >= 0.7:
                interpretacion = "La imagen muestra <strong>vegetaci√≥n muy vigorosa</strong> con tonos verdes intensos. "
                interpretacion += "Las √°reas m√°s oscuras (verdes) indican alta densidad de biomasa y excelente salud vegetal."
            elif valor_promedio >= 0.5:
                interpretacion = "La imagen muestra <strong>vegetaci√≥n saludable</strong> con predominio de tonos verdes. "
                interpretacion += "Se observa buena cobertura vegetal con desarrollo normal del cultivo."
            elif valor_promedio >= 0.3:
                interpretacion = "La imagen muestra <strong>vegetaci√≥n moderada</strong> con tonos amarillos-verdes. "
                interpretacion += "Posibles √°reas con menor vigor vegetal o cultivo en etapa temprana."
            else:
                interpretacion = "La imagen muestra <strong>baja vegetaci√≥n</strong> con tonos amarillos-marrones. "
                interpretacion += "Predominio de suelo desnudo o vegetaci√≥n muy dispersa/estresada."
        
        elif tipo_indice == 'NDMI':
            if valor_promedio >= 0.2:
                interpretacion = "La imagen refleja <strong>alto contenido de humedad</strong> en la vegetaci√≥n. "
                interpretacion += "Tonos azules-verdes indican buena hidrataci√≥n de las plantas."
            elif valor_promedio >= 0.0:
                interpretacion = "La imagen muestra <strong>contenido moderado de humedad</strong>. "
                interpretacion += "Vegetaci√≥n con niveles normales de agua."
            elif valor_promedio >= -0.2:
                interpretacion = "La imagen indica <strong>bajo contenido de humedad</strong>. "
                interpretacion += "Tonos c√°lidos sugieren estr√©s h√≠drico potencial o vegetaci√≥n seca."
            else:
                interpretacion = "La imagen muestra <strong>muy baja humedad</strong> con tonos rojos-marrones. "
                interpretacion += "Vegetaci√≥n severamente estresada o suelo desnudo."
        
        elif tipo_indice == 'SAVI':
            if valor_promedio >= 0.5:
                interpretacion = "La imagen muestra <strong>excelente cobertura vegetal</strong>. "
                interpretacion += "M√≠nima exposici√≥n de suelo desnudo visible."
            elif valor_promedio >= 0.3:
                interpretacion = "La imagen muestra <strong>buena cobertura vegetal</strong>. "
                interpretacion += "Vegetaci√≥n bien establecida con algo de suelo visible."
            else:
                interpretacion = "La imagen muestra <strong>cobertura vegetal baja</strong>. "
                interpretacion += "Considerable exposici√≥n de suelo desnudo entre la vegetaci√≥n."
        
        analisis_partes.append(interpretacion)
        
        # === AN√ÅLISIS ESPACIAL (si hay heterogeneidad) ===
        if indice.ndvi_maximo and indice.ndvi_minimo and tipo_indice == 'NDVI':
            rango = indice.ndvi_maximo - indice.ndvi_minimo
            if rango > 0.2:
                analisis_partes.append(
                    f"<br/><br/><strong>Variabilidad espacial:</strong> Se observa <strong>heterogeneidad significativa</strong> "
                    f"dentro de la parcela (rango: {rango:.3f}). Las √°reas m√°s claras pueden corresponder a zonas con "
                    f"menor vigor, posiblemente en las zonas perif√©ricas o √°reas con condiciones menos favorables."
                )
            else:
                analisis_partes.append(
                    "<br/><br/><strong>Uniformidad:</strong> La parcela muestra <strong>distribuci√≥n relativamente uniforme</strong> "
                    "del √≠ndice, lo que indica condiciones homog√©neas en la mayor√≠a del √°rea cultivada."
                )
        
        # === COMPARACI√ìN TEMPORAL (buscar mes anterior) ===
        try:
            # Buscar el mes anterior
            if indice.mes == 1:
                mes_anterior = indice.parcela.indices_mensuales.filter(
                    a√±o=indice.a√±o - 1, mes=12
                ).first()
            else:
                mes_anterior = indice.parcela.indices_mensuales.filter(
                    a√±o=indice.a√±o, mes=indice.mes - 1
                ).first()
            
            if mes_anterior:
                valor_anterior = None
                if tipo_indice == 'NDVI':
                    valor_anterior = mes_anterior.ndvi_promedio
                elif tipo_indice == 'NDMI':
                    valor_anterior = mes_anterior.ndmi_promedio
                elif tipo_indice == 'SAVI':
                    valor_anterior = mes_anterior.savi_promedio
                
                if valor_anterior:
                    cambio = valor_promedio - valor_anterior
                    cambio_pct = (cambio / abs(valor_anterior)) * 100 if valor_anterior != 0 else 0
                    
                    if abs(cambio) > 0.05:  # Cambio significativo
                        if cambio > 0:
                            analisis_partes.append(
                                f"<br/><br/><strong>Cambio temporal:</strong> Comparado con {mes_anterior.periodo_texto}, "
                                f"se observa un <strong>incremento notable</strong> ({cambio:+.3f}, {cambio_pct:+.1f}%). "
                                f"Visualmente esto se traduce en mayor intensidad de color verde/azul en la imagen actual, "
                                f"indicando mejora en las condiciones de la vegetaci√≥n."
                            )
                        else:
                            analisis_partes.append(
                                f"<br/><br/><strong>Cambio temporal:</strong> Comparado con {mes_anterior.periodo_texto}, "
                                f"se observa una <strong>disminuci√≥n notable</strong> ({cambio:.3f}, {cambio_pct:.1f}%). "
                                f"Visualmente se aprecia un cambio hacia tonos m√°s c√°lidos (amarillos/marrones), "
                                f"lo que sugiere reducci√≥n en vigor vegetal o contenido de humedad."
                            )
        except Exception as e:
            logger.debug(f"No se pudo comparar con mes anterior: {str(e)}")
        
        return "".join(analisis_partes)
    
    def _crear_tabla_datos(self, datos: List[Dict]) -> List:
        """Crea tabla con datos mensuales, usando Paragraphs y limpieza de HTML en todas las celdas"""
        elements = []
        
        # Agregar imagen decorativa superior (2.png) - M√ÅS GRANDE
        titulo_img_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', '2.png')
        if os.path.exists(titulo_img_path):
            try:
                img_decorativa = Image(titulo_img_path, width=12*cm, height=7*cm, kind='proportional')
                img_decorativa.hAlign = 'CENTER'
                elements.append(img_decorativa)
                elements.append(Spacer(1, 0.5*cm))
            except Exception as e:
                logger.warning(f"No se pudo cargar imagen decorativa 2.png: {e}")
        
        titulo = Paragraph("üìã Datos Mensuales Detallados", self.estilos['TituloSeccion'])
        elements.append(titulo)
        elements.append(Spacer(1, 0.5*cm))

        # Encabezados - AHORA CON NUBOSIDAD
        headers = [
            Paragraph("<b>Per√≠odo</b>", self.estilos['TextoNormal']),
            Paragraph("<b>NDVI</b>", self.estilos['TextoNormal']),
            Paragraph("<b>NDMI</b>", self.estilos['TextoNormal']),
            Paragraph("<b>SAVI</b>", self.estilos['TextoNormal']),
            Paragraph("<b>‚òÅÔ∏è Nub. (%)</b>", self.estilos['TextoNormal']),
            Paragraph("<b>Temp (¬∞C)</b>", self.estilos['TextoNormal']),
            Paragraph("<b>Precip (mm)</b>", self.estilos['TextoNormal'])
        ]
        table_data = [headers]

        for dato in datos:
            # Obtener nubosidad (si existe en el dato)
            nubosidad = dato.get('nubosidad_promedio', dato.get('nubosidad', None))
            nubosidad_str = f"{nubosidad:.1f}" if nubosidad is not None else 'N/D'
            
            row = [
                Paragraph(limpiar_html_completo(str(dato['periodo'])), self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(f"{dato.get('ndvi', 0):.3f}") if dato.get('ndvi') else 'N/D', self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(f"{dato.get('ndmi', 0):.3f}") if dato.get('ndmi') else 'N/D', self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(f"{dato.get('savi', 0):.3f}") if dato.get('savi') else 'N/D', self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(nubosidad_str), self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(f"{dato.get('temperatura', 0):.1f}") if dato.get('temperatura') else 'N/D', self.estilos['TextoNormal']),
                Paragraph(limpiar_html_completo(f"{dato.get('precipitacion', 0):.1f}") if dato.get('precipitacion') else 'N/D', self.estilos['TextoNormal'])
            ]
            table_data.append(row)

        tabla = Table(table_data, colWidths=[2.5*cm, 2*cm, 2*cm, 2*cm, 2*cm, 2*cm, 2.5*cm])
        tabla.setStyle(TableStyle([
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, 0), 9),
            ('FONTSIZE', (0, 1), (-1, -1), 8),
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2E7D32')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('TEXTCOLOR', (0, 1), (-1, -1), colors.HexColor('#2c3e50')),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#F1F8F4')]),
            ('LINEBELOW', (0, 0), (-1, 0), 1.5, colors.HexColor('#2E7D32')),
            ('LINEBELOW', (0, 1), (-1, -1), 0.5, colors.HexColor('#E0E0E0')),
            ('TOPPADDING', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
            ('LEFTPADDING', (0, 0), (-1, -1), 6),
            ('RIGHTPADDING', (0, 0), (-1, -1), 6),
        ]))
        elements.append(tabla)
        
        # Agregar imagen decorativa inferior (4.png) - M√ÅS GRANDE
        img_inf_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', '4.png')
        if os.path.exists(img_inf_path):
            try:
                elements.append(Spacer(1, 0.5*cm))
                img_inf = Image(img_inf_path, width=14*cm, height=6*cm, kind='proportional')
                img_inf.hAlign = 'CENTER'
                elements.append(img_inf)
            except Exception as e:
                logger.warning(f"No se pudo cargar imagen decorativa 4.png: {e}")
        
        return elements
    def _crear_pagina_creditos(self) -> List:
        """Crea p√°gina final con cr√©ditos e informaci√≥n legal"""
        elements = []
        
        # T√≠tulo
        titulo = Paragraph(
            '<para align="center"><font size="14" color="#2E7D32"><strong>Cr√©ditos e Informaci√≥n</strong></font></para>',
            self.estilos['TituloSeccion']
        )
        elements.append(titulo)
        elements.append(Spacer(1, 1*cm))
        
        # Secci√≥n de tecnolog√≠as
        tecnologias = Paragraph(
            '<para align="left">'
            '<font size="10" color="#2c3e50"><strong>üõ∞Ô∏è Tecnolog√≠as Satelitales</strong></font><br/>'
            '<font size="9" color="#555555">'
            '‚Ä¢ Im√°genes: Sentinel-2 (ESA Copernicus Programme)<br/>'
            '‚Ä¢ Resoluci√≥n espacial: 10-20 metros/p√≠xel<br/>'
            '‚Ä¢ √çndices espectrales: NDVI, NDMI, SAVI'
            '</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(tecnologias)
        elements.append(Spacer(1, 0.7*cm))
        
        # Secci√≥n de an√°lisis IA
        ia_info = Paragraph(
            '<para align="left">'
            '<font size="10" color="#2c3e50"><strong>ü§ñ An√°lisis Inteligente</strong></font><br/>'
            '<font size="9" color="#555555">'
            '‚Ä¢ Motor de IA: Google Gemini 2.0 Flash<br/>'
            '‚Ä¢ Procesamiento: An√°lisis espacial y temporal de patrones de cultivo<br/>'
            '‚Ä¢ Recomendaciones: Basadas en algoritmos cient√≠ficos validados'
            '</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(ia_info)
        elements.append(Spacer(1, 0.7*cm))
        
        # Cr√©ditos de im√°genes decorativas
        creditos_img = Paragraph(
            '<para align="left">'
            '<font size="10" color="#2c3e50"><strong>üì∏ Im√°genes Decorativas</strong></font><br/>'
            '<font size="8" color="#777777">'
            '‚Ä¢ Fotograf√≠a satelital: Unsplash (licencia libre)<br/>'
            '‚Ä¢ Im√°genes agr√≠colas: Unsplash Contributors<br/>'
            '‚Ä¢ Todas las im√°genes utilizadas bajo licencias de uso libre comercial'
            '</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(creditos_img)
        elements.append(Spacer(1, 1*cm))
        
        # Aviso legal
        aviso = Paragraph(
            '<para align="center">'
            '<font size="8" color="#999999">'
            '<i>Este informe fue generado autom√°ticamente por AgroTech Sistema de An√°lisis Satelital. '
            'Los datos y recomendaciones son de car√°cter informativo y deben ser complementados con '
            'inspecci√≥n de campo y criterio agron√≥mico profesional.</i>'
            '</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(aviso)
        elements.append(Spacer(1, 1.5*cm))
        
        # Logo y fecha al final
        footer_creditos = Paragraph(
            '<para align="center">'
            '<font size="10" color="#2E7D32"><strong>agrotech</strong></font><br/>'
            f'<font size="8" color="#888888">An√°lisis Satelital de Precisi√≥n ¬∑ {datetime.now().strftime("%Y")}</font>'
            '</para>',
            self.estilos['TextoNormal']
        )
        elements.append(footer_creditos)
        
        # Imagen decorativa bottom si existe
        img_bottom_path = os.path.join(settings.BASE_DIR, 'static', 'img', 'pdf_decorativas', 'cultivos_aereo.jpg')
        if os.path.exists(img_bottom_path):
            try:
                from reportlab.platypus import Flowable
                class ImagenDecorativaBottom(Flowable):
                    def __init__(self, width, height):
                        Flowable.__init__(self)
                        self.width = width
                        self.height = height
                    
                    def draw(self):
                        try:
                            self.canv.saveState()
                            self.canv.setFillAlpha(0.1)
                            self.canv.drawImage(img_bottom_path, 0, -2*cm, 
                                              width=self.width, height=4*cm, 
                                              preserveAspectRatio=True, mask='auto')
                            self.canv.restoreState()
                        except:
                            pass
                
                elements.append(Spacer(1, 1*cm))
                img_fondo = ImagenDecorativaBottom(17*cm, 4*cm)
                elements.append(img_fondo)
            except Exception as e:
                logger.warning(f"No se pudo agregar imagen decorativa bottom: {e}")
        
        return elements